package com.devc.lab.audios.manager;

import android.content.Context;
import android.media.MediaExtractor;
import android.media.MediaFormat;
import android.media.MediaMuxer;
import android.net.Uri;
import android.os.Handler;
import android.os.Looper;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.nio.ByteBuffer;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;

/**
 * Android Native API ê¸°ë°˜ ì˜¤ë””ì˜¤ ìë¥´ê¸° ê´€ë¦¬ì
 * MediaExtractor + MediaMuxerë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì‹œê°„ ê¸°ë°˜ìœ¼ë¡œ ìë¥´ê¸°
 * FFmpeg ì¢…ì†ì„±ì„ ì œê±°í•˜ê³  ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•œ Phase 3 êµ¬í˜„
 */
public class NativeAudioTrimManager {
    
    private static NativeAudioTrimManager instance;
    private Context context;
    
    // ì½œë°± ì¸í„°í˜ì´ìŠ¤ë“¤
    private OnTrimStartListener onStartListener;
    private OnTrimProgressListener onProgressListener;
    private OnTrimCompletionListener onCompletionListener;
    private OnTrimErrorListener onErrorListener;
    
    // ìŠ¤ë ˆë“œ ê´€ë¦¬
    private ExecutorService executorService;
    private Handler mainHandler;
    private Future<?> currentTask;
    private volatile boolean isTrimming = false;
    
    // MediaMuxer ìƒíƒœ ì¶”ì  (ë‹¨ìˆœí™”)
    private enum MuxerState {
        CREATED,    // ìƒì„±ë¨
        STARTED,    // ì‹œì‘ë¨
        STOPPED     // ì •ì§€ë¨
    }
    
    private volatile MuxerState muxerState = MuxerState.CREATED;
    private volatile boolean muxerNeedsStop = false; // stop() í˜¸ì¶œ í•„ìš” ì—¬ë¶€
    
    // ì§„í–‰ë¥  ì¶”ì 
    private long totalDurationUs = 0;
    private long processedDurationUs = 0;
    
    // ì½œë°± ì¸í„°í˜ì´ìŠ¤ ì •ì˜
    public interface OnTrimStartListener {
        void onTrimStart();
    }
    
    public interface OnTrimProgressListener {
        void onTrimProgress(int progress);
    }
    
    public interface OnTrimCompletionListener {
        void onTrimComplete(String outputPath);
    }
    
    public interface OnTrimErrorListener {
        void onTrimError(String error);
    }
    
    /**
     * ì§€ì›ë˜ëŠ” ì˜¤ë””ì˜¤ ì¶œë ¥ í¬ë§·
     */
    public enum AudioFormat {
        M4A("audio/mp4", ".m4a", MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4),
        WEBM("audio/webm", ".webm", MediaMuxer.OutputFormat.MUXER_OUTPUT_WEBM);
        
        private final String mimeType;
        private final String extension;
        private final int muxerFormat;
        
        AudioFormat(String mimeType, String extension, int muxerFormat) {
            this.mimeType = mimeType;
            this.extension = extension;
            this.muxerFormat = muxerFormat;
        }
        
        public String getMimeType() { return mimeType; }
        public String getExtension() { return extension; }
        public int getMuxerFormat() { return muxerFormat; }
    }
    
    private NativeAudioTrimManager() {
        executorService = Executors.newSingleThreadExecutor();
        mainHandler = new Handler(Looper.getMainLooper());
    }
    
    public static synchronized NativeAudioTrimManager getInstance() {
        if (instance == null) {
            instance = new NativeAudioTrimManager();
        }
        return instance;
    }
    
    public void init(Context context) {
        this.context = context.getApplicationContext();
        LoggerManager.logger("NativeAudioTrimManager ì´ˆê¸°í™” ì™„ë£Œ");
    }
    
    /**
     * ì˜¤ë””ì˜¤ íŒŒì¼ ìë¥´ê¸°
     * @param sourceUri ì›ë³¸ íŒŒì¼ URI
     * @param startTimeMs ì‹œì‘ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
     * @param endTimeMs ë ì‹œê°„ (ë°€ë¦¬ì´ˆ)
     * @param outputFileName ì¶œë ¥ íŒŒì¼ëª…
     */
    public void trimAudio(Uri sourceUri, long startTimeMs, long endTimeMs, String outputFileName) {
        LoggerManager.logger("==================== ğŸµ AUDIO TRIM START ====================");
        LoggerManager.logger("ğŸ“‹ ì…ë ¥ íŒŒë¼ë¯¸í„°:");
        LoggerManager.logger("   â†’ ì›ë³¸ URI: " + (sourceUri != null ? sourceUri.toString() : "NULL"));
        LoggerManager.logger("   â†’ ì‹œì‘ ì‹œê°„: " + startTimeMs + "ms");
        LoggerManager.logger("   â†’ ë ì‹œê°„: " + endTimeMs + "ms"); 
        LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ëª…: " + (outputFileName != null ? outputFileName : "NULL"));
        LoggerManager.logger("   â†’ ìë¥´ê¸° ê¸¸ì´: " + (endTimeMs - startTimeMs) + "ms");
        
        // íŒŒë¼ë¯¸í„° ê²€ì¦
        if (sourceUri == null || outputFileName == null) {
            LoggerManager.logger("âŒ íŒŒë¼ë¯¸í„° ê²€ì¦ ì‹¤íŒ¨: sourceUri ë˜ëŠ” outputFileNameì´ null");
            notifyError("ì…ë ¥ íŒŒë¼ë¯¸í„°ê°€ nullì…ë‹ˆë‹¤.");
            return;
        }
        
        if (startTimeMs >= endTimeMs) {
            LoggerManager.logger("âŒ íŒŒë¼ë¯¸í„° ê²€ì¦ ì‹¤íŒ¨: ì‹œì‘ ì‹œê°„(" + startTimeMs + ") >= ë ì‹œê°„(" + endTimeMs + ")");
            notifyError("ì‹œì‘ ì‹œê°„ì´ ë ì‹œê°„ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ìŠµë‹ˆë‹¤.");
            return;
        }
        
        if (isTrimming) {
            LoggerManager.logger("âš ï¸ ë‹¤ë¥¸ ìë¥´ê¸° ì‘ì—…ì´ ì§„í–‰ ì¤‘: isTrimming = true");
            notifyError("ë‹¤ë¥¸ ìë¥´ê¸° ì‘ì—…ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.");
            return;
        }
        
        LoggerManager.logger("âœ… íŒŒë¼ë¯¸í„° ê²€ì¦ í†µê³¼ - ìë¥´ê¸° ì‘ì—… ì‹œì‘");
        
        // ExecutorService ìƒíƒœ í™•ì¸ ë° ì¬ìƒì„±
        ensureExecutorServiceReady();
        
        currentTask = executorService.submit(() -> {
            try {
                // ğŸ¯ ì§€ëŠ¥ì  í¬ë§· ì„ íƒ: ì…ë ¥ í¬ë§·ì— ë”°ë¼ ìµœì ì˜ ì¶œë ¥ í¬ë§· ê²°ì •
                AudioFormat optimalFormat = determineOptimalOutputFormat(sourceUri);
                LoggerManager.logger("ğŸ¯ ì„ íƒëœ ì¶œë ¥ í¬ë§·: " + optimalFormat.name());
                
                performTrimming(sourceUri, startTimeMs, endTimeMs, outputFileName, optimalFormat);
            } catch (InterruptedException e) {
                LoggerManager.logger("â„¹ï¸ ì˜¤ë””ì˜¤ ìë¥´ê¸° ì‘ì—…ì´ ì¸í„°ëŸ½íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤");
                // ì¸í„°ëŸ½íŠ¸ ìƒíƒœ ë³µì›
                Thread.currentThread().interrupt();
                notifyError("ìë¥´ê¸° ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        });
    }
    
    /**
     * ì˜¤ë””ì˜¤ íŒŒì¼ ìë¥´ê¸° (ë¹„ìœ¨ ê¸°ë°˜)
     * @param sourceUri ì›ë³¸ íŒŒì¼ URI
     * @param startRatio ì‹œì‘ ìœ„ì¹˜ ë¹„ìœ¨ (0.0 ~ 1.0)
     * @param endRatio ë ìœ„ì¹˜ ë¹„ìœ¨ (0.0 ~ 1.0)
     * @param durationMs ì „ì²´ ê¸¸ì´ (ë°€ë¦¬ì´ˆ)
     * @param outputFileName ì¶œë ¥ íŒŒì¼ëª…
     */
    public void trimAudioByRatio(Uri sourceUri, float startRatio, float endRatio, 
                                 long durationMs, String outputFileName) {
        long startTimeMs = (long) (startRatio * durationMs);
        long endTimeMs = (long) (endRatio * durationMs);
        
        trimAudio(sourceUri, startTimeMs, endTimeMs, outputFileName);
    }
    
    /**
     * ì…ë ¥ í¬ë§·ì„ ë¶„ì„í•˜ì—¬ ìµœì ì˜ ì¶œë ¥ í¬ë§· ê²°ì • (í˜¸í™˜ì„± ìš°ì„ )
     */
    private AudioFormat determineOptimalOutputFormat(Uri sourceUri) {
        MediaExtractor formatAnalyzer = null;
        File tempFile = null;
        
        try {
            LoggerManager.logger("ğŸ” ì…ë ¥ í¬ë§· ë¶„ì„ ì‹œì‘: " + sourceUri.toString());
            
            // ì„ì‹œ íŒŒì¼ë¡œ ë³€í™˜ (ë¶„ì„ìš©)
            tempFile = createTempFileFromUri(sourceUri);
            if (tempFile == null) {
                LoggerManager.logger("âš ï¸ ì„ì‹œ íŒŒì¼ ìƒì„± ì‹¤íŒ¨ - ê¸°ë³¸ M4A í¬ë§· ì‚¬ìš©");
                return AudioFormat.M4A;
            }
            
            formatAnalyzer = new MediaExtractor();
            formatAnalyzer.setDataSource(tempFile.getAbsolutePath());
            
            // ì˜¤ë””ì˜¤ íŠ¸ë™ ì°¾ê¸°
            int audioTrackIndex = findAudioTrack(formatAnalyzer);
            if (audioTrackIndex < 0) {
                LoggerManager.logger("âš ï¸ ì˜¤ë””ì˜¤ íŠ¸ë™ ì—†ìŒ - ê¸°ë³¸ M4A í¬ë§· ì‚¬ìš©");
                return AudioFormat.M4A;
            }
            
            // ì˜¤ë””ì˜¤ í¬ë§· ë¶„ì„
            MediaFormat audioFormat = formatAnalyzer.getTrackFormat(audioTrackIndex);
            String inputMime = audioFormat.getString(MediaFormat.KEY_MIME);
            
            LoggerManager.logger("ğŸ“Š ì…ë ¥ ì˜¤ë””ì˜¤ ë¶„ì„ ê²°ê³¼:");
            LoggerManager.logger("   â†’ MIME íƒ€ì…: " + inputMime);
            
            if (audioFormat.containsKey(MediaFormat.KEY_SAMPLE_RATE)) {
                LoggerManager.logger("   â†’ ìƒ˜í”Œë ˆì´íŠ¸: " + audioFormat.getInteger(MediaFormat.KEY_SAMPLE_RATE) + "Hz");
            }
            if (audioFormat.containsKey(MediaFormat.KEY_CHANNEL_COUNT)) {
                LoggerManager.logger("   â†’ ì±„ë„ ìˆ˜: " + audioFormat.getInteger(MediaFormat.KEY_CHANNEL_COUNT));
            }
            if (audioFormat.containsKey(MediaFormat.KEY_BIT_RATE)) {
                LoggerManager.logger("   â†’ ë¹„íŠ¸ë ˆì´íŠ¸: " + audioFormat.getInteger(MediaFormat.KEY_BIT_RATE) + "bps");
            }
            
            // ğŸ¯ í¬ë§·ë³„ ìµœì  ì„ íƒ ë¡œì§
            AudioFormat selectedFormat = selectOptimalFormat(inputMime);
            
            LoggerManager.logger("âœ… í¬ë§· ë¶„ì„ ì™„ë£Œ:");
            LoggerManager.logger("   â†’ ì…ë ¥: " + inputMime);
            LoggerManager.logger("   â†’ ì¶œë ¥: " + selectedFormat.name() + " (" + selectedFormat.getMimeType() + ")");
            LoggerManager.logger("   â†’ ì„ íƒ ì´ìœ : " + getFormatSelectionReason(inputMime, selectedFormat));
            
            return selectedFormat;
            
        } catch (IOException e) {
            LoggerManager.logger("âŒ í¬ë§· ë¶„ì„ ì¤‘ IOException: " + e.getMessage());
            LoggerManager.logger("   â†’ ê¸°ë³¸ M4A í¬ë§·ìœ¼ë¡œ ëŒ€ì²´");
            return AudioFormat.M4A;
        } catch (Exception e) {
            LoggerManager.logger("âŒ í¬ë§· ë¶„ì„ ì¤‘ ì˜ˆì™¸: " + e.getClass().getSimpleName() + " - " + e.getMessage());
            LoggerManager.logger("   â†’ ê¸°ë³¸ M4A í¬ë§·ìœ¼ë¡œ ëŒ€ì²´");
            return AudioFormat.M4A;
        } finally {
            // ë¦¬ì†ŒìŠ¤ ì •ë¦¬
            if (formatAnalyzer != null) {
                try {
                    formatAnalyzer.release();
                } catch (Exception e) {
                    LoggerManager.logger("âš ï¸ formatAnalyzer í•´ì œ ì‹¤íŒ¨: " + e.getMessage());
                }
            }
            
            if (tempFile != null && tempFile.exists()) {
                boolean deleted = tempFile.delete();
                LoggerManager.logger("ğŸ§¹ ë¶„ì„ìš© ì„ì‹œ íŒŒì¼ ì‚­ì œ: " + (deleted ? "ì„±ê³µ" : "ì‹¤íŒ¨"));
            }
        }
    }
    
    /**
     * ì…ë ¥ MIME íƒ€ì…ì— ë”°ë¥¸ ìµœì  ì¶œë ¥ í¬ë§· ì„ íƒ
     */
    private AudioFormat selectOptimalFormat(String inputMime) {
        if (inputMime == null) {
            LoggerManager.logger("   â†’ MIME íƒ€ì… null - ê¸°ë³¸ M4A ì„ íƒ");
            return AudioFormat.M4A;
        }
        
        // ğŸµ í¬ë§·ë³„ í˜¸í™˜ì„± ìš°ì„  ìˆœìœ„
        switch (inputMime) {
            // AAC ê³„ì—´ (M4Aì™€ ì™„ë²½ í˜¸í™˜)
            case "audio/mp4a-latm":
            case "audio/aac":
                LoggerManager.logger("   â†’ AAC ê³„ì—´ ê°ì§€ - M4A ìµœì ");
                return AudioFormat.M4A;
                
            // MP3 (M4A ì»¨í…Œì´ë„ˆì—ì„œ ì§€ì›)
            case "audio/mpeg":
            case "audio/mp3":
                LoggerManager.logger("   â†’ MP3 ê°ì§€ - M4A í˜¸í™˜ ê°€ëŠ¥");
                return AudioFormat.M4A;
                
            // WAV/PCM (M4Aë¡œ ë³€í™˜ ê¶Œì¥)
            case "audio/wav":
            case "audio/x-wav":
            case "audio/raw":
            case "audio/pcm":
                LoggerManager.logger("   â†’ PCM ê³„ì—´ ê°ì§€ - M4A ë³€í™˜ ê¶Œì¥");
                return AudioFormat.M4A;
                
            // Vorbis/Opus (WEBMê³¼ í˜¸í™˜)
            case "audio/vorbis":
            case "audio/opus":
                LoggerManager.logger("   â†’ Vorbis/Opus ê°ì§€ - WEBM ìµœì ");
                return AudioFormat.WEBM;
                
            // FLAC (M4Aë¡œ ë³€í™˜)
            case "audio/flac":
                LoggerManager.logger("   â†’ FLAC ê°ì§€ - M4A ë³€í™˜ ê¶Œì¥");
                return AudioFormat.M4A;
                
            // ê¸°íƒ€ ë˜ëŠ” ì•Œ ìˆ˜ ì—†ëŠ” í¬ë§·
            default:
                LoggerManager.logger("   â†’ ì•Œ ìˆ˜ ì—†ëŠ” í¬ë§· (" + inputMime + ") - ë²”ìš© M4A ì„ íƒ");
                return AudioFormat.M4A;
        }
    }
    
    /**
     * í¬ë§· ì„ íƒ ì´ìœ  ì„¤ëª…
     */
    private String getFormatSelectionReason(String inputMime, AudioFormat selectedFormat) {
        if (inputMime == null) {
            return "ì…ë ¥ í¬ë§· ë¶ˆëª…ìœ¼ë¡œ ê¸°ë³¸ M4A ì„ íƒ";
        }
        
        switch (selectedFormat) {
            case M4A:
                if (inputMime.contains("aac") || inputMime.contains("mp4a")) {
                    return "AAC ë„¤ì´í‹°ë¸Œ í˜¸í™˜ì„± (ë³€í™˜ ì—†ìŒ)";
                } else if (inputMime.contains("mpeg") || inputMime.contains("mp3")) {
                    return "MP3â†’M4A ì»¨í…Œì´ë„ˆ í˜¸í™˜ì„±";
                } else if (inputMime.contains("wav") || inputMime.contains("pcm")) {
                    return "PCMâ†’AAC ê³ í’ˆì§ˆ ë³€í™˜";
                } else {
                    return "ë²”ìš© í˜¸í™˜ì„± (Android í‘œì¤€)";
                }
                
            case WEBM:
                if (inputMime.contains("vorbis") || inputMime.contains("opus")) {
                    return "Vorbis/Opus ë„¤ì´í‹°ë¸Œ í˜¸í™˜ì„±";
                } else {
                    return "WEBM ì»¨í…Œì´ë„ˆ ìµœì í™”";
                }
                
            default:
                return "ê¸°ë³¸ ì„ íƒ";
        }
    }
    
    /**
     * íŠ¸ë¦¬ë° í”„ë¡œì„¸ìŠ¤ì˜ ì¤‘ê°„ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤
     */
    private static class TrimProcessState {
        File tempInputFile;
        File tempOutputFile;
    }
    
    /**
     * ì˜¤ë””ì˜¤ íŠ¸ë™ ì •ë³´ë¥¼ ë‹´ëŠ” í´ë˜ìŠ¤
     */
    private static class AudioTrackInfo {
        int audioTrackIndex;
        MediaFormat audioFormat;
        
        AudioTrackInfo(int trackIndex, MediaFormat format) {
            this.audioTrackIndex = trackIndex;
            this.audioFormat = format;
        }
    }
    
    /**
     * MediaMuxer ì„¤ì • ê²°ê³¼ë¥¼ ë‹´ëŠ” í´ë˜ìŠ¤
     */
    private static class MuxerSetupResult {
        MediaMuxer muxer;
        int trackIndex;
        
        MuxerSetupResult(MediaMuxer muxer, int trackIndex) {
            this.muxer = muxer;
            this.trackIndex = trackIndex;
        }
    }

    /**
     * ì‹¤ì œ ì˜¤ë””ì˜¤ ìë¥´ê¸° ìˆ˜í–‰ (ì‚¬ìš©ì ì ‘ê·¼ ê°€ëŠ¥í•œ Downloads í´ë” ì €ì¥)
     */
    private void performTrimming(Uri sourceUri, long startTimeMs, long endTimeMs, 
                                String outputFileName, AudioFormat format) throws InterruptedException {
        LoggerManager.logger("ğŸ”§ === ìë¥´ê¸° ìˆ˜í–‰ ì‹œì‘ ===");
        
        // ìƒíƒœ ì´ˆê¸°í™” (ë‹¨ìˆœí™”)
        muxerState = MuxerState.CREATED;
        muxerNeedsStop = false;
        
        LoggerManager.logger("ğŸ¯ ì´ˆê¸° ìƒíƒœ ì„¤ì •:");
        LoggerManager.logger("   â†’ MediaMuxer ìƒíƒœ: " + muxerState);
        LoggerManager.logger("   â†’ ì¶œë ¥ í¬ë§·: " + format.name() + " (" + format.getMimeType() + ")");
        
        // ì¤‘ê°„ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ê²°ê³¼ ê°ì²´ë“¤
        TrimProcessState processState = new TrimProcessState();
        MediaExtractor extractor = null;
        MediaMuxer muxer = null;
        
        try {
            isTrimming = true;
            LoggerManager.logger("ğŸš€ ìë¥´ê¸° ì‘ì—… ì‹œì‘ - isTrimming = true");
            notifyStart();
            
            // STEP 1: URIë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ë³µì‚¬
            processState.tempInputFile = createTempInputFile(sourceUri);
            
            // STEP 2: ì„ì‹œ ì¶œë ¥ ë””ë ‰í† ë¦¬ ì„¤ì •
            processState.tempOutputFile = setupTempOutputDirectory(outputFileName, format);
            
            // STEP 3: MediaExtractor ì„¤ì •
            extractor = setupMediaExtractor(processState.tempInputFile);
            
            // STEP 4: ì˜¤ë””ì˜¤ íŠ¸ë™ ì„ íƒ ë° í¬ë§· ë¶„ì„
            AudioTrackInfo audioTrackInfo = analyzeAudioTrack(extractor, startTimeMs, endTimeMs, format);
            
            // STEP 5: MediaMuxer ì„¤ì • ë° íŠ¸ë™ ì¶”ê°€
            MuxerSetupResult muxerResult = setupMediaMuxer(processState.tempOutputFile, audioTrackInfo.audioFormat, format);
            muxer = muxerResult.muxer;
            
            // STEP 6: ì˜¤ë””ì˜¤ ë°ì´í„° ìë¥´ê¸° ë° ë³µì‚¬
            boolean copySuccess = copyAndTrimAudioData(extractor, muxer, muxerResult.trackIndex, startTimeMs * 1000, endTimeMs * 1000);
            
            // STEP 7: ì„ì‹œ íŒŒì¼ ê²€ì¦
            validateTrimmedFile(processState.tempOutputFile, copySuccess);
            
            // STEP 8: í¸ì§‘ ì „ìš© í´ë”ë¡œ íŒŒì¼ ì´ë™
            String finalOutputPath = moveToFinalDestination(processState.tempOutputFile, processState.tempOutputFile.getName());
            
            LoggerManager.logger("==================== ğŸ‰ AUDIO TRIM SUCCESS ====================");
            LoggerManager.logger("ğŸ‰ ì „ì²´ ìë¥´ê¸° í”„ë¡œì„¸ìŠ¤ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ!");
            LoggerManager.logger("   â†’ ìµœì¢… ì¶œë ¥ íŒŒì¼: " + finalOutputPath);
            
            // ìµœì¢… íŒŒì¼ ì •ë³´ í‘œì‹œ
            File finalFile = new File(finalOutputPath);
            if (finalFile.exists()) {
                LoggerManager.logger("ğŸ“Š ìµœì¢… íŒŒì¼ ì •ë³´:");
                LoggerManager.logger("   â†’ í¬ê¸°: " + finalFile.length() + " bytes (" + (finalFile.length()/1024) + " KB)");
                LoggerManager.logger("   â†’ ìœ„ì¹˜: " + finalFile.getParent());
                LoggerManager.logger("   â†’ íŒŒì¼ëª…: " + finalFile.getName());
                LoggerManager.logger("   â†’ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì ‘ê·¼: " + (finalOutputPath.contains("Edited") ? "âœ… ê°€ëŠ¥" : "âŒ ì œí•œë¨"));
            }
            notifyCompletion(finalOutputPath);
            
        } catch (InterruptedException e) {
            LoggerManager.logger("==================== âš ï¸ AUDIO TRIM INTERRUPTED ====================");
            LoggerManager.logger("â„¹ï¸ ì˜¤ë””ì˜¤ ìë¥´ê¸° ì‘ì—…ì´ ì¸í„°ëŸ½íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤");
            LoggerManager.logger("   â†’ ì˜ˆì™¸: " + e.getClass().getSimpleName());
            LoggerManager.logger("   â†’ ë©”ì‹œì§€: " + e.getMessage());
            LoggerManager.logger("   â†’ í˜„ì¬ ìƒíƒœ: " + muxerState);
            
            // ì¸í„°ëŸ½íŠ¸ ìƒíƒœ ë³µì›
            Thread.currentThread().interrupt();
            LoggerManager.logger("   â†’ Thread ì¸í„°ëŸ½íŠ¸ ìƒíƒœ ë³µì› ì™„ë£Œ");
            
            // ì¸í„°ëŸ½íŠ¸ ìƒí™©ì—ì„œ ìƒíƒœ ì •ë¦¬
            if (muxerState == MuxerState.STARTED) {
                muxerState = MuxerState.STOPPED;
                LoggerManager.logger("   â†’ MediaMuxer ìƒíƒœ ë³€ê²½: STARTED â†’ STOPPED (ì¸í„°ëŸ½íŠ¸ ì²˜ë¦¬)");
            }
            
            LoggerManager.logger("ğŸš« ìë¥´ê¸° ì‘ì—… ì·¨ì†Œ ì²˜ë¦¬ ì™„ë£Œ");
            notifyError("ìë¥´ê¸° ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            
        } catch (IOException e) {
            LoggerManager.logger("==================== âŒ AUDIO TRIM IO ERROR ====================");
            LoggerManager.logger("âŒ íŒŒì¼ ì…ì¶œë ¥ ì˜¤ë¥˜ ë°œìƒ");
            LoggerManager.logger("   â†’ ì˜ˆì™¸ íƒ€ì…: IOException");
            LoggerManager.logger("   â†’ ì˜¤ë¥˜ ë©”ì‹œì§€: " + e.getMessage());
            LoggerManager.logger("   â†’ í˜„ì¬ ìƒíƒœ: " + muxerState);
            LoggerManager.logger("   â†’ ê°€ëŠ¥í•œ ì›ì¸:");
            LoggerManager.logger("     - ì €ì¥ ê³µê°„ ë¶€ì¡±");
            LoggerManager.logger("     - íŒŒì¼ ê¶Œí•œ ë¬¸ì œ");
            LoggerManager.logger("     - ë””ìŠ¤í¬ ì˜¤ë¥˜");
            LoggerManager.logger("     - URI ì ‘ê·¼ ì‹¤íŒ¨");
            
            // ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ë¥¼ ë¡œê·¸ë¡œ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            e.printStackTrace();
            
            // IO ì˜¤ë¥˜ ìƒí™©ì—ì„œ ìƒíƒœ ì •ë¦¬
            if (muxerState == MuxerState.STARTED) {
                muxerState = MuxerState.STOPPED;
                LoggerManager.logger("   â†’ MediaMuxer ìƒíƒœ ë³€ê²½: STARTED â†’ STOPPED (IO ì˜¤ë¥˜)");
            }
            
            notifyError("íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.getMessage());
            
        } catch (IllegalStateException e) {
            LoggerManager.logger("==================== âŒ AUDIO TRIM STATE ERROR ====================");
            LoggerManager.logger("âŒ MediaMuxer/MediaExtractor ìƒíƒœ ì˜¤ë¥˜ ë°œìƒ");
            LoggerManager.logger("   â†’ ì˜ˆì™¸ íƒ€ì…: IllegalStateException");
            LoggerManager.logger("   â†’ ì˜¤ë¥˜ ë©”ì‹œì§€: " + e.getMessage());
            LoggerManager.logger("   â†’ í˜„ì¬ Muxer ìƒíƒœ: " + muxerState);
            LoggerManager.logger("   â†’ ê°€ëŠ¥í•œ ì›ì¸:");
            LoggerManager.logger("     - MediaMuxer ìƒíƒœ ë¶ˆì¼ì¹˜");
            LoggerManager.logger("     - ì˜¤ë””ì˜¤ íŠ¸ë™ í˜¸í™˜ì„± ë¬¸ì œ");
            LoggerManager.logger("     - ì˜ëª»ëœ MediaFormat");
            
            e.printStackTrace();
            
            muxerState = MuxerState.STOPPED;
            LoggerManager.logger("   â†’ MediaMuxer ìƒíƒœë¥¼ STOPPEDë¡œ ë³€ê²½");
            
            notifyError("ë¯¸ë””ì–´ ì²˜ë¦¬ ìƒíƒœ ì˜¤ë¥˜: " + e.getMessage());
            
        } catch (Exception e) {
            LoggerManager.logger("==================== âŒ AUDIO TRIM UNEXPECTED ERROR ====================");
            LoggerManager.logger("âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ");
            LoggerManager.logger("   â†’ ì˜ˆì™¸ íƒ€ì…: " + e.getClass().getSimpleName());
            LoggerManager.logger("   â†’ ì˜¤ë¥˜ ë©”ì‹œì§€: " + e.getMessage());
            LoggerManager.logger("   â†’ í˜„ì¬ ìƒíƒœ: " + muxerState);
            
            // ìƒì„¸í•œ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤
            LoggerManager.logger("ğŸ“‹ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:");
            e.printStackTrace();
            
            // ì˜ˆì™¸ ë°œìƒ ì‹œ ìƒíƒœ ì •ë¦¬
            if (muxerState == MuxerState.STARTED) {
                muxerState = MuxerState.STOPPED;
                LoggerManager.logger("   â†’ MediaMuxer ìƒíƒœ ë³€ê²½: STARTED â†’ STOPPED (ì˜ˆì™¸ ì²˜ë¦¬)");
            }
            
            LoggerManager.logger("ğŸ” ë””ë²„ê¹… ì •ë³´:");
            LoggerManager.logger("   â†’ isTrimming: " + isTrimming);
            LoggerManager.logger("   â†’ muxerNeedsStop: " + muxerNeedsStop);
            
            notifyError("ì˜¤ë””ì˜¤ ìë¥´ê¸° ì‹¤íŒ¨: " + e.getMessage());
            
        } finally {
            LoggerManager.logger("==================== ğŸ§¹ CLEANUP PROCESS START ====================");
            LoggerManager.logger("ğŸ§¹ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì‹œì‘...");
            LoggerManager.logger("   â†’ ìµœì¢… ìƒíƒœ: " + muxerState);
            
            // MediaMuxer ì •ë¦¬ (ë‹¨ìˆœí™”)
            if (muxer != null) {
                LoggerManager.logger("ğŸ¬ MediaMuxer ì •ë¦¬ ì¤‘...");
                LoggerManager.logger("   â†’ ì •ë¦¬ ì‹œì‘ ìƒíƒœ: " + muxerState);
                cleanupMediaMuxer(muxer);
            } else {
                LoggerManager.logger("â„¹ï¸ MediaMuxerê°€ null - ì •ë¦¬ ìƒëµ");
            }
            
            if (extractor != null) {
                LoggerManager.logger("ğŸµ MediaExtractor ì •ë¦¬ ì¤‘...");
                try {
                    extractor.release();
                    LoggerManager.logger("   â†’ MediaExtractor ì •ë¦¬ ì„±ê³µ");
                } catch (Exception e) {
                    LoggerManager.logger("   â†’ MediaExtractor ì •ë¦¬ ì‹¤íŒ¨: " + e.getClass().getSimpleName() + " - " + e.getMessage());
                }
            } else {
                LoggerManager.logger("â„¹ï¸ MediaExtractorê°€ null - ì •ë¦¬ ìƒëµ");
            }
            
            // ì„ì‹œ íŒŒì¼ ì •ë¦¬
            LoggerManager.logger("ğŸ“ ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘...");
            int deletedFiles = 0;
            
            if (processState.tempInputFile != null && processState.tempInputFile.exists()) {
                boolean deleted = processState.tempInputFile.delete();
                if (deleted) {
                    deletedFiles++;
                    LoggerManager.logger("   â†’ ì„ì‹œ ì…ë ¥ íŒŒì¼ ì‚­ì œ ì„±ê³µ: " + processState.tempInputFile.getName());
                } else {
                    LoggerManager.logger("   â†’ ì„ì‹œ ì…ë ¥ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: " + processState.tempInputFile.getName());
                }
            } else if (processState.tempInputFile != null) {
                LoggerManager.logger("   â†’ ì„ì‹œ ì…ë ¥ íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: " + processState.tempInputFile.getName());
            }
            
            if (processState.tempOutputFile != null && processState.tempOutputFile.exists()) {
                // ì„ì‹œ ì¶œë ¥ íŒŒì¼ ì‚­ì œ (ì„±ê³µì ìœ¼ë¡œ ì´ë™ë˜ì—ˆë‹¤ë©´)
                boolean deleted = processState.tempOutputFile.delete();
                if (deleted) {
                    deletedFiles++;
                    LoggerManager.logger("   â†’ ì„ì‹œ ì¶œë ¥ íŒŒì¼ ì‚­ì œ ì„±ê³µ: " + processState.tempOutputFile.getName());
                } else {
                    LoggerManager.logger("   â†’ ì„ì‹œ ì¶œë ¥ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: " + processState.tempOutputFile.getName());
                }
            } else if (processState.tempOutputFile != null) {
                LoggerManager.logger("   â†’ ì„ì‹œ ì¶œë ¥ íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: " + processState.tempOutputFile.getName());
            }
            
            LoggerManager.logger("ğŸ“Š ì„ì‹œ íŒŒì¼ ì •ë¦¬ ê²°ê³¼: " + deletedFiles + "ê°œ íŒŒì¼ ì‚­ì œ");
            
            // ìƒíƒœ í”Œë˜ê·¸ ì´ˆê¸°í™” (ë‹¨ìˆœí™”)
            boolean prevIsTrimming = isTrimming;
            isTrimming = false;
            muxerNeedsStop = false;
            
            LoggerManager.logger("ğŸ”„ ìƒíƒœ í”Œë˜ê·¸ ì´ˆê¸°í™”:");
            LoggerManager.logger("   â†’ isTrimming: " + prevIsTrimming + " â†’ false");
            LoggerManager.logger("   â†’ muxerNeedsStop: " + muxerNeedsStop + " â†’ false");
            
            LoggerManager.logger("âœ… ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ - ë‹¤ìŒ ì‘ì—… ì¤€ë¹„ë¨");
            LoggerManager.logger("==================== ğŸ§¹ CLEANUP PROCESS END ====================");
        }
    }
    
    /**
     * MediaFormat ìƒì„¸ ì •ë³´ ë¡œê¹…
     */
    private void logDetailedAudioFormat(MediaFormat format) {
        try {
            LoggerManager.logger("=== ì˜¤ë””ì˜¤ í¬ë§· ìƒì„¸ ì •ë³´ ===");
            
            // ê¸°ë³¸ ì •ë³´
            String mime = format.getString(MediaFormat.KEY_MIME);
            LoggerManager.logger("MIME íƒ€ì…: " + mime);
            
            // ì˜¤ë””ì˜¤ ì†ì„±ë“¤
            if (format.containsKey(MediaFormat.KEY_SAMPLE_RATE)) {
                LoggerManager.logger("ìƒ˜í”Œë ˆì´íŠ¸: " + format.getInteger(MediaFormat.KEY_SAMPLE_RATE) + "Hz");
            }
            
            if (format.containsKey(MediaFormat.KEY_CHANNEL_COUNT)) {
                LoggerManager.logger("ì±„ë„ ìˆ˜: " + format.getInteger(MediaFormat.KEY_CHANNEL_COUNT));
            }
            
            if (format.containsKey(MediaFormat.KEY_BIT_RATE)) {
                LoggerManager.logger("ë¹„íŠ¸ë ˆì´íŠ¸: " + format.getInteger(MediaFormat.KEY_BIT_RATE) + "bps");
            }
            
            if (format.containsKey(MediaFormat.KEY_DURATION)) {
                long durationUs = format.getLong(MediaFormat.KEY_DURATION);
                LoggerManager.logger("ê¸¸ì´: " + (durationUs / 1000) + "ms");
            }
            
            if (format.containsKey(MediaFormat.KEY_MAX_INPUT_SIZE)) {
                LoggerManager.logger("ìµœëŒ€ ì…ë ¥ í¬ê¸°: " + format.getInteger(MediaFormat.KEY_MAX_INPUT_SIZE) + " bytes");
            }
            
            // ì „ì²´ í¬ë§· ì •ë³´
            LoggerManager.logger("ì „ì²´ í¬ë§·: " + format.toString());
            LoggerManager.logger("========================");
            
        } catch (Exception e) {
            LoggerManager.logger("MediaFormat ì •ë³´ ì¶”ì¶œ ì‹¤íŒ¨: " + e.getMessage());
        }
    }
    
    /**
     * MediaMuxerì— íŠ¸ë™ ì¶”ê°€ (ë‹¨ìˆœí™”ëœ í˜¸í™˜ì„± ê²€ì¦)
     */
    private int addTrackWithCompatibilityCheck(MediaMuxer muxer, MediaFormat audioFormat, AudioFormat outputFormat) {
        try {
            LoggerManager.logger("ğŸ¯ MediaMuxer íŠ¸ë™ ì¶”ê°€ (ë‹¨ìˆœí™”ëœ ë°©ì‹)");
            
            String inputMime = audioFormat.getString(MediaFormat.KEY_MIME);
            LoggerManager.logger("   â†’ ì…ë ¥ MIME: " + inputMime);
            LoggerManager.logger("   â†’ ì¶œë ¥ í¬ë§·: " + outputFormat.name() + " (" + outputFormat.getMimeType() + ")");
            
            // ğŸš€ 1ë‹¨ê³„: ì›ë³¸ MediaFormat ê·¸ëŒ€ë¡œ ì‚¬ìš© (ê°€ì¥ ì•ˆì „í•œ ë°©ë²•)
            try {
                LoggerManager.logger("   â†’ 1ë‹¨ê³„: ì›ë³¸ MediaFormat ê·¸ëŒ€ë¡œ ì‹œë„");
                int trackIndex = muxer.addTrack(audioFormat);
                LoggerManager.logger("âœ… ì›ë³¸ í¬ë§·ìœ¼ë¡œ íŠ¸ë™ ì¶”ê°€ ì„±ê³µ - ì¸ë±ìŠ¤: " + trackIndex);
                LoggerManager.logger("   â†’ ë°ì´í„° ë³€í™˜ ì—†ì´ ì§ì ‘ ë³µì‚¬ ê°€ëŠ¥ (ìµœì  ì„±ëŠ¥)");
                return trackIndex;
                
            } catch (IllegalArgumentException e) {
                LoggerManager.logger("   âš ï¸ 1ë‹¨ê³„ ì‹¤íŒ¨ (í¬ë§· ë¹„í˜¸í™˜): " + e.getMessage());
                
                // IllegalArgumentExceptionì€ í¬ë§· í˜¸í™˜ì„± ë¬¸ì œë¥¼ ì˜ë¯¸
                // ì´ ê²½ìš°ì—ë§Œ 2ë‹¨ê³„ ì‹œë„
                
            } catch (Exception e) {
                LoggerManager.logger("   âŒ 1ë‹¨ê³„ ì‹¤íŒ¨ (ê¸°íƒ€ ì˜¤ë¥˜): " + e.getClass().getSimpleName() + " - " + e.getMessage());
                // ê¸°íƒ€ ì˜¤ë¥˜ëŠ” ê·¼ë³¸ì ì¸ ë¬¸ì œì´ë¯€ë¡œ ë°”ë¡œ ì‹¤íŒ¨ ì²˜ë¦¬
                return -1;
            }
            
            // ğŸ”§ 2ë‹¨ê³„: ìµœì†Œí•œì˜ ì•ˆì „í•œ ìˆ˜ì •ë§Œ ì ìš©
            LoggerManager.logger("   â†’ 2ë‹¨ê³„: ì•ˆì „í•œ MediaFormat ìˆ˜ì • ì‹œë„");
            MediaFormat safeFormat = createSafeMediaFormat(audioFormat, outputFormat);
            
            if (safeFormat != null) {
                try {
                    int trackIndex = muxer.addTrack(safeFormat);
                    LoggerManager.logger("âœ… ì•ˆì „í•œ í¬ë§·ìœ¼ë¡œ íŠ¸ë™ ì¶”ê°€ ì„±ê³µ - ì¸ë±ìŠ¤: " + trackIndex);
                    LoggerManager.logger("   â†’ ìµœì†Œí•œì˜ í¬ë§· ì¡°ì •ìœ¼ë¡œ í˜¸í™˜ì„± í™•ë³´");
                    return trackIndex;
                    
                } catch (Exception e) {
                    LoggerManager.logger("   âŒ 2ë‹¨ê³„ë„ ì‹¤íŒ¨: " + e.getMessage());
                }
            } else {
                LoggerManager.logger("   âš ï¸ ì•ˆì „í•œ MediaFormat ìƒì„± ë¶ˆê°€");
            }
            
            // ëª¨ë“  ì‹œë„ ì‹¤íŒ¨
            LoggerManager.logger("âŒ ëª¨ë“  íŠ¸ë™ ì¶”ê°€ ì‹œë„ ì‹¤íŒ¨");
            LoggerManager.logger("   â†’ ì›ì¸: " + inputMime + " â†” " + outputFormat.getMimeType() + " í¬ë§· ë¹„í˜¸í™˜");
            LoggerManager.logger("   â†’ ê¶Œì¥: ë‹¤ë¥¸ ì¶œë ¥ í¬ë§· ì‚¬ìš© ë˜ëŠ” ì›ë³¸ í¬ë§· í™•ì¸");
            
            return -1;
            
        } catch (Exception e) {
            LoggerManager.logger("âŒ íŠ¸ë™ ì¶”ê°€ í”„ë¡œì„¸ìŠ¤ ì „ì²´ ì‹¤íŒ¨: " + e.getClass().getSimpleName() + " - " + e.getMessage());
            return -1;
        }
    }
    
    /**
     * ì•ˆì „í•œ MediaFormat ìƒì„± (ìµœì†Œí•œì˜ ê²€ì¦ëœ ìˆ˜ì •ë§Œ)
     */
    private MediaFormat createSafeMediaFormat(MediaFormat originalFormat, AudioFormat outputFormat) {
        try {
            LoggerManager.logger("ğŸ”§ ì•ˆì „í•œ MediaFormat ìƒì„± ì‹œë„");
            
            String originalMime = originalFormat.getString(MediaFormat.KEY_MIME);
            if (originalMime == null) {
                LoggerManager.logger("   âŒ ì›ë³¸ MIME íƒ€ì…ì´ null");
                return null;
            }
            
            // ê¸°ë³¸ì ìœ¼ë¡œ ì›ë³¸ í¬ë§·ì„ ë³µì‚¬
            MediaFormat safeFormat = new MediaFormat();
            
            // í•„ìˆ˜ ë©”íƒ€ë°ì´í„°ë§Œ ë³µì‚¬ (ì•ˆì „í•œ ê°’ë“¤)
            try {
                // MIME íƒ€ì… (ì›ë³¸ ìœ ì§€ê°€ ê°€ì¥ ì•ˆì „)
                safeFormat.setString(MediaFormat.KEY_MIME, originalMime);
                LoggerManager.logger("   â†’ MIME íƒ€ì…: " + originalMime + " (ì›ë³¸ ìœ ì§€)");
                
                // ìƒ˜í”Œë ˆì´íŠ¸ (í•„ìˆ˜)
                if (originalFormat.containsKey(MediaFormat.KEY_SAMPLE_RATE)) {
                    int sampleRate = originalFormat.getInteger(MediaFormat.KEY_SAMPLE_RATE);
                    safeFormat.setInteger(MediaFormat.KEY_SAMPLE_RATE, sampleRate);
                    LoggerManager.logger("   â†’ ìƒ˜í”Œë ˆì´íŠ¸: " + sampleRate + "Hz");
                }
                
                // ì±„ë„ ìˆ˜ (í•„ìˆ˜)
                if (originalFormat.containsKey(MediaFormat.KEY_CHANNEL_COUNT)) {
                    int channels = originalFormat.getInteger(MediaFormat.KEY_CHANNEL_COUNT);
                    safeFormat.setInteger(MediaFormat.KEY_CHANNEL_COUNT, channels);
                    LoggerManager.logger("   â†’ ì±„ë„ ìˆ˜: " + channels);
                }
                
                // ë¹„íŠ¸ë ˆì´íŠ¸ (ìˆëŠ” ê²½ìš°ì—ë§Œ)
                if (originalFormat.containsKey(MediaFormat.KEY_BIT_RATE)) {
                    int bitRate = originalFormat.getInteger(MediaFormat.KEY_BIT_RATE);
                    safeFormat.setInteger(MediaFormat.KEY_BIT_RATE, bitRate);
                    LoggerManager.logger("   â†’ ë¹„íŠ¸ë ˆì´íŠ¸: " + bitRate + "bps");
                }
                
                // ìµœëŒ€ ì…ë ¥ í¬ê¸° (ìˆëŠ” ê²½ìš°ì—ë§Œ)
                if (originalFormat.containsKey(MediaFormat.KEY_MAX_INPUT_SIZE)) {
                    int maxInputSize = originalFormat.getInteger(MediaFormat.KEY_MAX_INPUT_SIZE);
                    safeFormat.setInteger(MediaFormat.KEY_MAX_INPUT_SIZE, maxInputSize);
                    LoggerManager.logger("   â†’ ìµœëŒ€ ì…ë ¥ í¬ê¸°: " + maxInputSize + " bytes");
                }
                
                LoggerManager.logger("âœ… ì•ˆì „í•œ MediaFormat ìƒì„± ì™„ë£Œ");
                LoggerManager.logger("   â†’ ì›ë³¸ ë©”íƒ€ë°ì´í„° ë³´ì¡´ìœ¼ë¡œ ìµœëŒ€ í˜¸í™˜ì„± í™•ë³´");
                
                return safeFormat;
                
            } catch (Exception e) {
                LoggerManager.logger("   âŒ MediaFormat ìƒì„± ì¤‘ ì˜¤ë¥˜: " + e.getMessage());
                return null;
            }
            
        } catch (Exception e) {
            LoggerManager.logger("âŒ ì•ˆì „í•œ MediaFormat ìƒì„± ì‹¤íŒ¨: " + e.getMessage());
            return null;
        }
    }
    

    /**
     * ì˜¤ë””ì˜¤ íŠ¸ë™ ì¸ë±ìŠ¤ ì°¾ê¸°
     */
    private int findAudioTrack(MediaExtractor extractor) {
        int trackCount = extractor.getTrackCount();
        LoggerManager.logger("ì´ íŠ¸ë™ ìˆ˜: " + trackCount);
        
        for (int i = 0; i < trackCount; i++) {
            MediaFormat format = extractor.getTrackFormat(i);
            String mime = format.getString(MediaFormat.KEY_MIME);
            LoggerManager.logger("íŠ¸ë™ " + i + " MIME: " + mime);
            
            if (mime != null && mime.startsWith("audio/")) {
                LoggerManager.logger("ì˜¤ë””ì˜¤ íŠ¸ë™ ë°œê²¬: ì¸ë±ìŠ¤ " + i);
                return i;
            }
        }
        
        return -1;
    }
    
    /**
     * MediaMuxer ì •ë¦¬ (ë‹¨ìˆœí™”ëœ ë°©ì‹)
     */
    private void cleanupMediaMuxer(MediaMuxer muxer) {
        if (muxer == null) {
            LoggerManager.logger("â„¹ï¸ MediaMuxerê°€ null - ì •ë¦¬ ë¶ˆí•„ìš”");
            return;
        }
        
        try {
            LoggerManager.logger("ğŸ”§ MediaMuxer ì •ë¦¬ ì‹œì‘ (ìƒíƒœ: " + muxerState + ")");
            
            // Step 1: í•„ìš”ì‹œ stop() í˜¸ì¶œ (íŒŒì¼ ì™„ì„±ì„ ìœ„í•œ í•µì‹¬ ë‹¨ê³„)
            if (muxerNeedsStop && muxerState == MuxerState.STARTED) {
                try {
                    LoggerManager.logger("   â†’ stop() í˜¸ì¶œ ì¤‘ - íŒŒì¼ ì™„ì„±ì„ ìœ„í•œ ì¤‘ìš” ë‹¨ê³„");
                    
                    long stopStartTime = System.currentTimeMillis();
                    muxer.stop();
                    long stopDuration = System.currentTimeMillis() - stopStartTime;
                    
                    muxerState = MuxerState.STOPPED;
                    LoggerManager.logger("   âœ… stop() ì„±ê³µ (" + stopDuration + "ms)");
                    
                    // stop() í˜¸ì¶œ í›„ ìƒíƒœ í™•ì¸ ì™„ë£Œ
                    LoggerManager.logger("   â†’ MediaMuxer stop() ì™„ë£Œë¡œ íŒŒì¼ í—¤ë” ë° ë©”íƒ€ë°ì´í„° ì™„ì„±");
                    
                } catch (IllegalStateException e) {
                    // MediaMuxerê°€ ì´ë¯¸ ì •ì§€ë˜ì—ˆê±°ë‚˜ ë‚´ë¶€ì ìœ¼ë¡œ ì™„ë£Œëœ ìƒí™©
                    LoggerManager.logger("   â„¹ï¸ stop() ë¶ˆí•„ìš” (ì´ë¯¸ ì •ì§€ë¨): " + e.getMessage());
                    muxerState = MuxerState.STOPPED;
                } catch (Exception e) {
                    LoggerManager.logger("   âš ï¸ stop() ì‹¤íŒ¨: " + e.getClass().getSimpleName() + " - " + e.getMessage());
                    LoggerManager.logger("   â†’ stop() ì‹¤íŒ¨ëŠ” íŒŒì¼ ìƒì„± ì‹¤íŒ¨ë¥¼ ì˜ë¯¸í•  ìˆ˜ ìˆìŒ");
                    LoggerManager.logger("   â†’ ê°€ëŠ¥í•œ ì›ì¸: ë°ì´í„° ë¶€ì¡±, í¬ë§· ì˜¤ë¥˜, ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡±");
                    muxerState = MuxerState.STOPPED; // ì–´ì¨Œë“  ì •ì§€ ìƒíƒœë¡œ ì²˜ë¦¬
                }
            } else {
                LoggerManager.logger("   â†’ stop() í˜¸ì¶œ ë¶ˆí•„ìš” (ìƒíƒœ: " + muxerState + ", needsStop: " + muxerNeedsStop + ")");
                if (muxerState != MuxerState.STARTED) {
                    LoggerManager.logger("   âš ï¸ MediaMuxerê°€ STARTED ìƒíƒœê°€ ì•„ë‹˜ - íŒŒì¼ì´ ì™„ì„±ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŒ");
                }
            }
            
            // Step 2: release() í˜¸ì¶œ
            try {
                LoggerManager.logger("   â†’ release() í˜¸ì¶œ ì¤‘...");
                muxer.release();
                LoggerManager.logger("   âœ… release() ì„±ê³µ");
            } catch (Exception e) {
                LoggerManager.logger("   âš ï¸ release() ì‹¤íŒ¨: " + e.getClass().getSimpleName() + " - " + e.getMessage());
                // release() ì‹¤íŒ¨ëŠ” ì¹˜ëª…ì ì´ì§€ ì•ŠìŒ
            }
            
            // ìƒíƒœ ë¦¬ì…‹
            muxerNeedsStop = false;
            LoggerManager.logger("âœ… MediaMuxer ì •ë¦¬ ì™„ë£Œ");
            
        } catch (Exception e) {
            LoggerManager.logger("âŒ MediaMuxer ì •ë¦¬ ì¤‘ ì˜ˆì™¸: " + e.getClass().getSimpleName() + " - " + e.getMessage());
            // ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ ìƒíƒœëŠ” ë¦¬ì…‹
            muxerState = MuxerState.STOPPED;
            muxerNeedsStop = false;
        }
    }
    
    /**
     * ì˜¤ë””ì˜¤ íŠ¸ë™ ë°ì´í„° ìë¥´ê¸° ë° ë³µì‚¬ (ê°œì„ ëœ ì˜¤ë¥˜ ì²˜ë¦¬)
     */
    private boolean trimAndCopyAudioTrack(MediaExtractor extractor, MediaMuxer muxer, 
                                         int muxerTrackIndex, long startTimeUs, long endTimeUs) 
                                         throws InterruptedException {
        
        ByteBuffer buffer = ByteBuffer.allocate(256 * 1024); // 256KB ë²„í¼
        android.media.MediaCodec.BufferInfo bufferInfo = new android.media.MediaCodec.BufferInfo();
        
        boolean copySuccess = true; // ë³µì‚¬ ì„±ê³µ ì—¬ë¶€ ì¶”ì 
        
        // ì‹œì‘ ìœ„ì¹˜ë¡œ íƒìƒ‰
        extractor.seekTo(startTimeUs, MediaExtractor.SEEK_TO_PREVIOUS_SYNC);
        
        // ì •í™•í•œ ì‹œì‘ ì‹œê°„ê¹Œì§€ ì´ë™
        while (extractor.getSampleTime() < startTimeUs && extractor.getSampleTime() >= 0) {
            extractor.advance();
        }
        
        int sampleCount = 0;
        long lastProgressTime = 0;
        long trimDurationUs = endTimeUs - startTimeUs;
        
        LoggerManager.logger("ğŸµ ì˜¤ë””ì˜¤ ìƒ˜í”Œ ë°ì´í„° ìë¥´ê¸° ì‹œì‘:");
        LoggerManager.logger("   â†’ ìë¥´ê¸° êµ¬ê°„: " + startTimeUs + " ~ " + endTimeUs + " Î¼s");
        LoggerManager.logger("   â†’ ì˜ˆìƒ ìë¥´ê¸° ê¸¸ì´: " + trimDurationUs + " Î¼s (" + (trimDurationUs/1000) + "ms)");
        LoggerManager.logger("   â†’ ëŒ€ìƒ MediaMuxer íŠ¸ë™: " + muxerTrackIndex);
        LoggerManager.logger("   â†’ ë²„í¼ í¬ê¸°: 256KB");
        
        while (true) {
            // Thread ì¸í„°ëŸ½íŠ¸ ì²´í¬
            if (Thread.currentThread().isInterrupted()) {
                LoggerManager.logger("â„¹ï¸ Thread ì¸í„°ëŸ½íŠ¸ ê°ì§€ - ìë¥´ê¸° ì¤‘ë‹¨");
                throw new InterruptedException("ì˜¤ë””ì˜¤ ìë¥´ê¸° ì‘ì—…ì´ ì¸í„°ëŸ½íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤");
            }
            
            long sampleTimeUs = extractor.getSampleTime();
            
            // ì¢…ë£Œ ì¡°ê±´ í™•ì¸
            if (sampleTimeUs < 0 || sampleTimeUs > endTimeUs) {
                break;
            }
            
            int sampleSize = extractor.readSampleData(buffer, 0);
            if (sampleSize < 0) {
                break;
            }
            
            // ìƒ˜í”Œ ì •ë³´ ì„¤ì • (ì‹œê°„ ì˜¤í”„ì…‹ ì¡°ì •)
            long adjustedTimeUs = sampleTimeUs - startTimeUs;
            bufferInfo.presentationTimeUs = adjustedTimeUs;
            bufferInfo.flags = extractor.getSampleFlags();
            bufferInfo.size = sampleSize;
            bufferInfo.offset = 0;
            
            // ì²« ë²ˆì§¸ ìƒ˜í”Œì— ëŒ€í•œ ìƒì„¸ ë¡œê¹…
            if (sampleCount == 0) {
                LoggerManager.logger("ğŸµ ì²« ë²ˆì§¸ ìƒ˜í”Œ ë°œê²¬:");
                LoggerManager.logger("   â†’ ì›ë³¸ ì‹œê°„: " + sampleTimeUs + " Î¼s (" + (sampleTimeUs/1000) + "ms)");
                LoggerManager.logger("   â†’ ì¡°ì •ëœ ì‹œê°„: " + adjustedTimeUs + " Î¼s (" + (adjustedTimeUs/1000) + "ms)");
                LoggerManager.logger("   â†’ ìƒ˜í”Œ í¬ê¸°: " + sampleSize + " bytes");
                LoggerManager.logger("   â†’ ìƒ˜í”Œ í”Œë˜ê·¸: " + bufferInfo.flags);
            }
            
            // MediaMuxerì— ìƒ˜í”Œ ì“°ê¸° (í–¥ìƒëœ ì˜¤ë¥˜ ì²˜ë¦¬)
            try {
                muxer.writeSampleData(muxerTrackIndex, buffer, bufferInfo);
                
                // ì²« ë²ˆì§¸ì™€ ë§ˆì§€ë§‰ ìƒ˜í”Œì— ëŒ€í•œ ìƒì„¸ ë¡œê¹…
                if (sampleCount == 0) {
                    LoggerManager.logger("ğŸµ ì²« ë²ˆì§¸ ìƒ˜í”Œ ì“°ê¸° ì„±ê³µ:");
                    LoggerManager.logger("   â†’ ìƒ˜í”Œ í¬ê¸°: " + sampleSize + " bytes");
                    LoggerManager.logger("   â†’ íƒ€ì„ìŠ¤íƒ¬í”„: " + bufferInfo.presentationTimeUs + " Î¼s");
                    LoggerManager.logger("   â†’ í”Œë˜ê·¸: " + bufferInfo.flags);
                } else if (sampleCount % 1000 == 0) {
                    LoggerManager.logger("ğŸ”„ ì§„í–‰ ì¤‘ - ìƒ˜í”Œ " + sampleCount + " ì²˜ë¦¬ ì™„ë£Œ (" + (sampleTimeUs/1000) + "ms)");
                }
                
            } catch (IllegalArgumentException e) {
                LoggerManager.logger("âŒ writeSampleData ì‹¤íŒ¨ - IllegalArgumentException: " + e.getMessage());
                LoggerManager.logger("   â†’ ìƒ˜í”Œ " + sampleCount + "ì—ì„œ í¬ë§· ê´€ë ¨ ì˜¤ë¥˜ ë°œìƒ");
                LoggerManager.logger("   â†’ ìƒ˜í”Œ ì •ë³´: í¬ê¸°=" + sampleSize + ", ì‹œê°„=" + sampleTimeUs + "Î¼s, í”Œë˜ê·¸=" + bufferInfo.flags);
                LoggerManager.logger("   â†’ MediaMuxer íŠ¸ë™ ì¸ë±ìŠ¤: " + muxerTrackIndex);
                LoggerManager.logger("   â†’ ìƒì„¸ ë””ë²„ê¹… ì •ë³´:");
                LoggerManager.logger("     * ì¡°ì •ëœ íƒ€ì„ìŠ¤íƒ¬í”„: " + adjustedTimeUs + "Î¼s");
                LoggerManager.logger("     * ë²„í¼ ìœ„ì¹˜: " + bufferInfo.offset);
                LoggerManager.logger("     * ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: " + android.util.Log.getStackTraceString(e));
                LoggerManager.logger("   â†’ ê°€ëŠ¥í•œ ì›ì¸: í¬ë§· í˜¸í™˜ì„±, íŠ¸ë™ ì„¤ì •, íƒ€ì„ìŠ¤íƒ¬í”„ ë¬¸ì œ");
                LoggerManager.logger("   â†’ ë³µêµ¬ ì‹œë„: í˜„ì¬ê¹Œì§€ ì²˜ë¦¬ëœ " + sampleCount + "ê°œ ìƒ˜í”Œë¡œ íŒŒì¼ ì™„ì„±");
                copySuccess = false;
                break;
            } catch (IllegalStateException e) {
                LoggerManager.logger("âŒ writeSampleData ì‹¤íŒ¨ - IllegalStateException: " + e.getMessage());
                LoggerManager.logger("   â†’ ìƒ˜í”Œ " + sampleCount + "ì—ì„œ ìƒíƒœ ê´€ë ¨ ì˜¤ë¥˜ ë°œìƒ");
                LoggerManager.logger("   â†’ MediaMuxer ìƒíƒœ: " + muxerState);
                LoggerManager.logger("   â†’ ìƒì„¸ ë””ë²„ê¹… ì •ë³´:");
                LoggerManager.logger("     * MediaMuxer íŠ¸ë™ ì¸ë±ìŠ¤: " + muxerTrackIndex);
                LoggerManager.logger("     * muxerNeedsStop: " + muxerNeedsStop);
                LoggerManager.logger("     * í˜„ì¬ ìƒ˜í”Œ í¬ê¸°: " + sampleSize + " bytes");
                LoggerManager.logger("     * ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: " + android.util.Log.getStackTraceString(e));
                LoggerManager.logger("   â†’ ê°€ëŠ¥í•œ ì›ì¸: MediaMuxer ìƒíƒœ ë¶ˆì¼ì¹˜, start() í˜¸ì¶œ ëˆ„ë½");
                LoggerManager.logger("   â†’ ë³µêµ¬ ì‹œë„: í˜„ì¬ê¹Œì§€ ì²˜ë¦¬ëœ " + sampleCount + "ê°œ ìƒ˜í”Œë¡œ íŒŒì¼ ì™„ì„±");
                copySuccess = false;
                break;
            } catch (Exception e) {
                LoggerManager.logger("âŒ writeSampleData ì‹¤íŒ¨ - " + e.getClass().getSimpleName() + ": " + e.getMessage());
                LoggerManager.logger("   â†’ ìƒ˜í”Œ " + sampleCount + "ì—ì„œ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ");
                LoggerManager.logger("   â†’ ìƒì„¸ ì •ë³´: í¬ê¸°=" + sampleSize + ", ì‹œê°„=" + sampleTimeUs + "Î¼s");
                LoggerManager.logger("   â†’ ì‹œìŠ¤í…œ ì •ë³´:");
                LoggerManager.logger("     * ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬: " + (Runtime.getRuntime().freeMemory() / 1024 / 1024) + " MB");
                LoggerManager.logger("     * ë²„í¼ ì •ë³´: ìœ„ì¹˜=" + bufferInfo.offset + ", í¬ê¸°=" + bufferInfo.size);
                LoggerManager.logger("     * ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: " + android.util.Log.getStackTraceString(e));
                LoggerManager.logger("   â†’ ë³µêµ¬ ì‹œë„: í˜„ì¬ê¹Œì§€ ì²˜ë¦¬ëœ " + sampleCount + "ê°œ ìƒ˜í”Œë¡œ íŒŒì¼ ì™„ì„±");
                copySuccess = false;
                break; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë£¨í”„ ì¢…ë£Œ
            }
            
            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (100msë§ˆë‹¤)
            processedDurationUs = sampleTimeUs - startTimeUs;
            long currentTime = System.currentTimeMillis();
            if (currentTime - lastProgressTime > 100) {
                updateTrimProgress(processedDurationUs, trimDurationUs);
                lastProgressTime = currentTime;
            }
            
            sampleCount++;
            extractor.advance();
        }
        
        LoggerManager.logger("ğŸµ ì˜¤ë””ì˜¤ ìƒ˜í”Œ ì²˜ë¦¬ ì™„ë£Œ:");
        LoggerManager.logger("   â†’ ì´ ì²˜ë¦¬ëœ ìƒ˜í”Œ ìˆ˜: " + sampleCount);
        LoggerManager.logger("   â†’ ì²˜ë¦¬ ì„±ê³µ: " + copySuccess);
        LoggerManager.logger("   â†’ ë§ˆì§€ë§‰ ìƒ˜í”Œ ì‹œê°„: " + (processedDurationUs/1000) + "ms");
        LoggerManager.logger("   â†’ ì „ì²´ ì§„í–‰ë¥ : " + (trimDurationUs > 0 ? (processedDurationUs * 100 / trimDurationUs) + "%" : "ê³„ì‚° ë¶ˆê°€"));
        
        if (copySuccess) {
            LoggerManager.logger("   âœ… ëª¨ë“  ì˜¤ë””ì˜¤ ë°ì´í„°ê°€ MediaMuxerì— ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë¨");
            LoggerManager.logger("   â†’ ì´ì œ MediaMuxer.stop() í˜¸ì¶œë¡œ íŒŒì¼ì„ ì™„ì„±í•´ì•¼ í•¨");
        } else {
            LoggerManager.logger("   âŒ ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨ - íŒŒì¼ì´ ì™„ì„±ë˜ì§€ ì•ŠìŒ");
            if (sampleCount == 0) {
                LoggerManager.logger("   â†’ ìƒ˜í”Œì„ ì „í˜€ ì²˜ë¦¬í•˜ì§€ ëª»í•¨ - MediaExtractor ë¬¸ì œ ê°€ëŠ¥ì„±");
                LoggerManager.logger("   â†’ ê°€ëŠ¥í•œ ì›ì¸:");
                LoggerManager.logger("     * ì›ë³¸ íŒŒì¼ì´ ì†ìƒë¨");
                LoggerManager.logger("     * ì§€ì›ë˜ì§€ ì•ŠëŠ” ì˜¤ë””ì˜¤ í¬ë§·");
                LoggerManager.logger("     * seekTo() ì‹¤íŒ¨ë¡œ ì‹œì‘ ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í•¨");
                LoggerManager.logger("     * ìë¥´ê¸° êµ¬ê°„ì´ íŒŒì¼ ë²”ìœ„ë¥¼ ì´ˆê³¼í•¨");
            } else {
                LoggerManager.logger("   â†’ ìƒ˜í”Œ " + sampleCount + "ê°œ ì²˜ë¦¬ í›„ ì¤‘ë‹¨ë¨ - MediaMuxer ì˜¤ë¥˜ ê°€ëŠ¥ì„±");
                LoggerManager.logger("   â†’ ë¶€ë¶„ ì²˜ë¦¬ ìƒì„¸ ì •ë³´:");
                LoggerManager.logger("     * ì²˜ë¦¬ëœ ìƒ˜í”Œ ìˆ˜: " + sampleCount);
                LoggerManager.logger("     * ì²˜ë¦¬ëœ ì‹œê°„: " + (processedDurationUs/1000) + "ms");
                LoggerManager.logger("     * ì „ì²´ ëŒ€ë¹„ ì§„í–‰ë¥ : " + (trimDurationUs > 0 ? (processedDurationUs * 100 / trimDurationUs) + "%" : "ê³„ì‚° ë¶ˆê°€"));
                LoggerManager.logger("     * ê°•ì œ ì™„ì„± ì‹œë„: MediaMuxer.stop()ìœ¼ë¡œ ë¶€ë¶„ íŒŒì¼ ìƒì„±");
                LoggerManager.logger("   â†’ ê°€ëŠ¥í•œ ì›ì¸:");
                LoggerManager.logger("     * MediaMuxer ë‚´ë¶€ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°");
                LoggerManager.logger("     * ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡±");
                LoggerManager.logger("     * íƒ€ì„ìŠ¤íƒ¬í”„ ë¶ˆì¼ì¹˜ ë¬¸ì œ");
                LoggerManager.logger("     * ìƒ˜í”Œ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜");
            }
        }
        
        // ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ìµœì¢… ì§„í–‰ë¥  100%
        if (copySuccess) {
            notifyProgress(100);
        }
        
        return copySuccess;
    }
    
    /**
     * ìë¥´ê¸° ì§„í–‰ë¥  ê³„ì‚° ë° ì½œë°±
     */
    private void updateTrimProgress(long processedUs, long totalUs) {
        if (totalUs > 0) {
            int progress = (int) ((processedUs * 100) / totalUs);
            progress = Math.min(Math.max(progress, 0), 100);
            notifyProgress(progress);
        }
    }
    
    /**
     * URIì—ì„œ ì„ì‹œ íŒŒì¼ ìƒì„±
     */
    private File createTempFileFromUri(Uri uri) {
        try {
            // ì„ì‹œ ë””ë ‰í† ë¦¬
            File tempDir = new File(context.getCacheDir(), "temp_audio_trimmer");
            if (!tempDir.exists()) {
                tempDir.mkdirs();
            }
            
            // ì„ì‹œ íŒŒì¼
            File tempFile = new File(tempDir, "temp_trim_" + System.currentTimeMillis() + ".tmp");
            
            // URIì—ì„œ íŒŒì¼ë¡œ ë³µì‚¬
            try (InputStream inputStream = context.getContentResolver().openInputStream(uri);
                 FileOutputStream outputStream = new FileOutputStream(tempFile)) {
                
                if (inputStream == null) {
                    LoggerManager.logger("URIì—ì„œ InputStreamì„ ì—´ ìˆ˜ ì—†ìŒ");
                    return null;
                }
                
                byte[] buffer = new byte[8 * 1024];
                int bytesRead;
                
                while ((bytesRead = inputStream.read(buffer)) != -1) {
                    outputStream.write(buffer, 0, bytesRead);
                }
                
                outputStream.flush();
                LoggerManager.logger("ì„ì‹œ íŒŒì¼ ìƒì„± ì™„ë£Œ: " + tempFile.getAbsolutePath());
                return tempFile;
                
            } catch (IOException e) {
                LoggerManager.logger("ì„ì‹œ íŒŒì¼ ìƒì„± ì‹¤íŒ¨: " + e.getMessage());
                if (tempFile.exists()) {
                    tempFile.delete();
                }
                return null;
            }
            
        } catch (Exception e) {
            LoggerManager.logger("ì„ì‹œ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜: " + e.getMessage());
            return null;
        }
    }
    
    /**
     * ìë¥´ê¸° ì·¨ì†Œ (ë‹¨ìˆœí™”)
     */
    public void cancelTrimming() {
        try {
            if (currentTask != null && !currentTask.isDone()) {
                LoggerManager.logger("â„¹ï¸ ì˜¤ë””ì˜¤ ìë¥´ê¸° ì·¨ì†Œ ìš”ì²­");
                boolean cancelled = currentTask.cancel(true);
                LoggerManager.logger("âœ… ìë¥´ê¸° ì‘ì—… ì·¨ì†Œ " + (cancelled ? "ì„±ê³µ" : "ì‹¤íŒ¨ ë˜ëŠ” ì´ë¯¸ ì™„ë£Œ"));
            } else {
                LoggerManager.logger("â„¹ï¸ ì·¨ì†Œí•  ì‘ì—…ì´ ì—†ìŒ");
            }
        } catch (Exception e) {
            LoggerManager.logger("âŒ ìë¥´ê¸° ì·¨ì†Œ ì‹¤íŒ¨: " + e.getClass().getSimpleName() + " - " + e.getMessage());
        }
    }
    
    /**
     * í˜„ì¬ ìë¥´ê¸° ì¤‘ì¸ì§€ í™•ì¸
     */
    public boolean isTrimming() {
        return isTrimming;
    }
    
    /**
     * ìµœì¢… ì¶œë ¥ íŒŒì¼ ê²€ì¦ (ê°•í™”ëœ ê²€ì¦ + ì‹¤ì œ ì˜¤ë””ì˜¤ ë°ì´í„° ê²€ì¦)
     */
    private boolean verifyFinalOutputFile(String outputPath) {
        try {
            if (outputPath == null || outputPath.isEmpty()) {
                LoggerManager.logger("âŒ ì¶œë ¥ íŒŒì¼ ê²½ë¡œê°€ null ë˜ëŠ” ë¹„ì–´ìˆìŒ");
                return false;
            }
            
            File outputFile = new File(outputPath);
            
            // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            if (!outputFile.exists()) {
                LoggerManager.logger("âŒ ì¶œë ¥ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: " + outputPath);
                return false;
            }
            
            // íŒŒì¼ í¬ê¸° í™•ì¸ (0ë°”ì´íŠ¸ íŒŒì¼ ë°©ì§€)
            long fileSize = outputFile.length();
            if (fileSize <= 0) {
                LoggerManager.logger("âŒ ì¶œë ¥ íŒŒì¼ í¬ê¸°ê°€ 0ë°”ì´íŠ¸: " + outputPath);
                return false;
            }
            
            // íŒŒì¼ ì½ê¸° ê¶Œí•œ í™•ì¸
            if (!outputFile.canRead()) {
                LoggerManager.logger("âŒ ì¶œë ¥ íŒŒì¼ ì½ê¸° ê¶Œí•œ ì—†ìŒ: " + outputPath);
                return false;
            }
            
            // ìµœì†Œ í¬ê¸° ê²€ì¦ (1KB ë¯¸ë§Œì´ë©´ ë¹„ì •ìƒì¼ ê°€ëŠ¥ì„±)
            if (fileSize < 1024) {
                LoggerManager.logger("âš ï¸ ì¶œë ¥ íŒŒì¼ì´ ë§¤ìš° ì‘ìŒ (1KB ë¯¸ë§Œ): " + fileSize + " bytes");
                // ì‘ì§€ë§Œ ì¡´ì¬í•˜ë¯€ë¡œ ì¼ë‹¨ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
            }
            
            LoggerManager.logger("âœ… ê¸°ë³¸ íŒŒì¼ ê²€ì¦ ì„±ê³µ");
            LoggerManager.logger("   â†’ íŒŒì¼ ê²½ë¡œ: " + outputPath);
            LoggerManager.logger("   â†’ íŒŒì¼ í¬ê¸°: " + fileSize + " bytes (" + (fileSize / 1024) + " KB)");
            LoggerManager.logger("   â†’ ë§ˆì§€ë§‰ ìˆ˜ì •: " + new java.util.Date(outputFile.lastModified()));
            
            // ğŸµ ì‹¤ì œ ì˜¤ë””ì˜¤ ë°ì´í„° ê²€ì¦ (í•µì‹¬ ì¶”ê°€ ê¸°ëŠ¥)
            boolean audioValidation = verifyAudioDataIntegrity(outputPath);
            if (!audioValidation) {
                LoggerManager.logger("âŒ ì˜¤ë””ì˜¤ ë°ì´í„° ê²€ì¦ ì‹¤íŒ¨: íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì¬ìƒ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤");
                return false;
            }
            
            LoggerManager.logger("âœ… ì™„ì „í•œ íŒŒì¼ ê²€ì¦ ì„±ê³µ - ì¬ìƒ ê°€ëŠ¥í•œ ì˜¤ë””ì˜¤ íŒŒì¼");
            return true;
            
        } catch (Exception e) {
            LoggerManager.logger("âŒ ì¶œë ¥ íŒŒì¼ ê²€ì¦ ì¤‘ ì˜ˆì™¸ ë°œìƒ: " + e.getClass().getSimpleName() + " - " + e.getMessage());
            return false;
        }
    }
    
    /**
     * ì‹¤ì œ ì˜¤ë””ì˜¤ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ (MediaExtractor ê¸°ë°˜)
     */
    private boolean verifyAudioDataIntegrity(String filePath) {
        MediaExtractor verifyExtractor = null;
        try {
            LoggerManager.logger("ğŸµ ì˜¤ë””ì˜¤ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ ì‹œì‘: " + filePath);
            
            verifyExtractor = new MediaExtractor();
            verifyExtractor.setDataSource(filePath);
            
            // íŠ¸ë™ ìˆ˜ í™•ì¸
            int trackCount = verifyExtractor.getTrackCount();
            LoggerManager.logger("   â†’ ê²€ì¶œëœ íŠ¸ë™ ìˆ˜: " + trackCount);
            
            if (trackCount == 0) {
                LoggerManager.logger("âŒ íŠ¸ë™ì´ ì—†ëŠ” íŒŒì¼");
                return false;
            }
            
            // ì˜¤ë””ì˜¤ íŠ¸ë™ ì°¾ê¸°
            int audioTrackIndex = -1;
            MediaFormat audioFormat = null;
            
            for (int i = 0; i < trackCount; i++) {
                MediaFormat format = verifyExtractor.getTrackFormat(i);
                String mime = format.getString(MediaFormat.KEY_MIME);
                LoggerManager.logger("   â†’ íŠ¸ë™ " + i + " MIME: " + mime);
                
                if (mime != null && mime.startsWith("audio/")) {
                    audioTrackIndex = i;
                    audioFormat = format;
                    LoggerManager.logger("   âœ… ì˜¤ë””ì˜¤ íŠ¸ë™ ë°œê²¬: ì¸ë±ìŠ¤ " + audioTrackIndex);
                    break;
                }
            }
            
            // ì˜¤ë””ì˜¤ íŠ¸ë™ì´ ì—†ìœ¼ë©´ ì‹¤íŒ¨
            if (audioTrackIndex < 0) {
                LoggerManager.logger("âŒ ì˜¤ë””ì˜¤ íŠ¸ë™ì´ ì—†ìŠµë‹ˆë‹¤");
                return false;
            }
            
            // ì˜¤ë””ì˜¤ íŠ¸ë™ ì„ íƒ ë° ë©”íƒ€ë°ì´í„° ê²€ì¦
            verifyExtractor.selectTrack(audioTrackIndex);
            
            // í•„ìˆ˜ ë©”íƒ€ë°ì´í„° ê²€ì¦
            String mimeType = audioFormat.getString(MediaFormat.KEY_MIME);
            boolean hasSampleRate = audioFormat.containsKey(MediaFormat.KEY_SAMPLE_RATE);
            boolean hasChannelCount = audioFormat.containsKey(MediaFormat.KEY_CHANNEL_COUNT);
            boolean hasDuration = audioFormat.containsKey(MediaFormat.KEY_DURATION);
            
            LoggerManager.logger("ğŸ“Š ì˜¤ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¶„ì„:");
            LoggerManager.logger("   â†’ MIME íƒ€ì…: " + mimeType);
            if (hasSampleRate) {
                LoggerManager.logger("   â†’ ìƒ˜í”Œë ˆì´íŠ¸: " + audioFormat.getInteger(MediaFormat.KEY_SAMPLE_RATE) + "Hz");
            } else {
                LoggerManager.logger("   âš ï¸ ìƒ˜í”Œë ˆì´íŠ¸ ì •ë³´ ì—†ìŒ");
            }
            if (hasChannelCount) {
                LoggerManager.logger("   â†’ ì±„ë„ ìˆ˜: " + audioFormat.getInteger(MediaFormat.KEY_CHANNEL_COUNT));
            } else {
                LoggerManager.logger("   âš ï¸ ì±„ë„ ì •ë³´ ì—†ìŒ");
            }
            if (hasDuration) {
                long durationUs = audioFormat.getLong(MediaFormat.KEY_DURATION);
                LoggerManager.logger("   â†’ ê¸¸ì´: " + (durationUs / 1000) + "ms (" + (durationUs / 1000000) + "ì´ˆ)");
                
                // ê¸¸ì´ê°€ 0ì´ë©´ ë¬¸ì œ ìˆìŒ
                if (durationUs <= 0) {
                    LoggerManager.logger("âŒ ì˜¤ë””ì˜¤ ê¸¸ì´ê°€ 0 ë˜ëŠ” ìŒìˆ˜: " + durationUs);
                    return false;
                }
            } else {
                LoggerManager.logger("   âš ï¸ ê¸¸ì´ ì •ë³´ ì—†ìŒ");
            }
            
            // ì‹¤ì œ ìƒ˜í”Œ ë°ì´í„° ê²€ì¦ (ì²« ëª‡ ê°œ ìƒ˜í”Œ ì½ê¸° ì‹œë„)
            ByteBuffer sampleBuffer = ByteBuffer.allocate(1024);
            int validSamples = 0;
            int maxSamplesToCheck = 10;
            
            LoggerManager.logger("ğŸ” ì‹¤ì œ ìƒ˜í”Œ ë°ì´í„° ê²€ì¦ ì‹œì‘ (ìµœëŒ€ " + maxSamplesToCheck + "ê°œ)");
            
            while (validSamples < maxSamplesToCheck) {
                long sampleTime = verifyExtractor.getSampleTime();
                if (sampleTime < 0) {
                    LoggerManager.logger("   â†’ ìƒ˜í”Œ ì¢…ë£Œ ê°ì§€ (ì‹œê°„: " + sampleTime + ")");
                    break;
                }
                
                int sampleSize = verifyExtractor.readSampleData(sampleBuffer, 0);
                if (sampleSize < 0) {
                    LoggerManager.logger("   â†’ ìƒ˜í”Œ ë°ì´í„° ì½ê¸° ì¢…ë£Œ");
                    break;
                }
                
                if (sampleSize > 0) {
                    validSamples++;
                    LoggerManager.logger("   â†’ ìƒ˜í”Œ " + validSamples + ": " + sampleSize + " bytes (ì‹œê°„: " + (sampleTime / 1000) + "ms)");
                }
                
                if (!verifyExtractor.advance()) {
                    LoggerManager.logger("   â†’ MediaExtractor advance ì¢…ë£Œ");
                    break;
                }
                
                sampleBuffer.clear();
            }
            
            LoggerManager.logger("ğŸ“‹ ìƒ˜í”Œ ê²€ì¦ ê²°ê³¼: " + validSamples + "ê°œ ìœ íš¨ ìƒ˜í”Œ í™•ì¸");
            
            // ìµœì†Œ 1ê°œì˜ ìœ íš¨í•œ ìƒ˜í”Œì´ ìˆì–´ì•¼ í•¨
            if (validSamples == 0) {
                LoggerManager.logger("âŒ ìœ íš¨í•œ ì˜¤ë””ì˜¤ ìƒ˜í”Œì´ ì—†ìŠµë‹ˆë‹¤");
                return false;
            }
            
            // í•„ìˆ˜ ë©”íƒ€ë°ì´í„° í™•ì¸
            if (mimeType == null) {
                LoggerManager.logger("âŒ MIME íƒ€ì… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤");
                return false;
            }
            
            LoggerManager.logger("âœ… ì˜¤ë””ì˜¤ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ ì™„ë£Œ");
            LoggerManager.logger("   â†’ ìœ íš¨í•œ " + mimeType + " í¬ë§·");
            LoggerManager.logger("   â†’ " + validSamples + "ê°œ ìƒ˜í”Œ í™•ì¸");
            LoggerManager.logger("   â†’ ì¬ìƒ ê°€ëŠ¥í•œ ì˜¤ë””ì˜¤ íŒŒì¼ë¡œ íŒì •");
            
            return true;
            
        } catch (IOException e) {
            LoggerManager.logger("âŒ ì˜¤ë””ì˜¤ ê²€ì¦ ì¤‘ IOException: " + e.getMessage());
            return false;
        } catch (Exception e) {
            LoggerManager.logger("âŒ ì˜¤ë””ì˜¤ ê²€ì¦ ì¤‘ ì˜ˆì™¸: " + e.getClass().getSimpleName() + " - " + e.getMessage());
            return false;
        } finally {
            if (verifyExtractor != null) {
                try {
                    verifyExtractor.release();
                    LoggerManager.logger("   â†’ ê²€ì¦ìš© MediaExtractor í•´ì œ ì™„ë£Œ");
                } catch (Exception e) {
                    LoggerManager.logger("   âš ï¸ ê²€ì¦ìš© MediaExtractor í•´ì œ ì‹¤íŒ¨: " + e.getMessage());
                }
            }
        }
    }
    
    /**
     * ì½œë°± ì•Œë¦¼ ë©”ì„œë“œë“¤
     */
    private void notifyStart() {
        if (onStartListener != null) {
            mainHandler.post(() -> onStartListener.onTrimStart());
        }
    }
    
    private void notifyProgress(int progress) {
        if (onProgressListener != null) {
            mainHandler.post(() -> onProgressListener.onTrimProgress(progress));
        }
    }
    
    private void notifyCompletion(String outputPath) {
        if (onCompletionListener != null) {
            mainHandler.post(() -> onCompletionListener.onTrimComplete(outputPath));
        }
    }
    
    private void notifyError(String error) {
        if (onErrorListener != null) {
            mainHandler.post(() -> onErrorListener.onTrimError(error));
        }
    }
    
    /**
     * ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë©”ì„œë“œë“¤
     */
    public void setOnStartListener(OnTrimStartListener listener) {
        this.onStartListener = listener;
    }
    
    public void setOnProgressListener(OnTrimProgressListener listener) {
        this.onProgressListener = listener;
    }
    
    public void setOnCompletionListener(OnTrimCompletionListener listener) {
        this.onCompletionListener = listener;
    }
    
    public void setOnErrorListener(OnTrimErrorListener listener) {
        this.onErrorListener = listener;
    }
    
    /**
     * ëª¨ë“  ë¦¬ìŠ¤ë„ˆ ì œê±°
     */
    public void clearListeners() {
        onStartListener = null;
        onProgressListener = null;
        onCompletionListener = null;
        onErrorListener = null;
    }
    
    /**
     * ì„ì‹œ íŒŒì¼ì„ í¸ì§‘ ì „ìš© ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—°ë™)
     * FileManagerì˜ getEditedDirectory() í™œìš©
     */
    private String moveToEditedDirectory(File tempFile, String fileName) {
        try {
            LoggerManager.logger("ğŸ“ í¸ì§‘ ì „ìš© ë””ë ‰í† ë¦¬ë¡œ íŒŒì¼ ì´ë™ ì‹œì‘: " + fileName);
            
            // FileManagerë¥¼ í†µí•´ í¸ì§‘ ë””ë ‰í† ë¦¬ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
            FileManager fileManager = new FileManager(context);
            File editedDir = fileManager.getEditedDirectory(context);
            
            // í¸ì§‘ ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒì„±
            if (!editedDir.exists()) {
                boolean dirCreated = editedDir.mkdirs();
                LoggerManager.logger("   â†’ í¸ì§‘ ë””ë ‰í† ë¦¬ ìƒì„±: " + (dirCreated ? "ì„±ê³µ" : "ì‹¤íŒ¨"));
                if (!dirCreated) {
                    LoggerManager.logger("âŒ í¸ì§‘ ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨: " + editedDir.getAbsolutePath());
                    return null;
                }
            }
            
            // ìµœì¢… ëŒ€ìƒ íŒŒì¼ ê²½ë¡œ ìƒì„±
            File destFile = new File(editedDir, fileName);
            
            // ì¤‘ë³µ íŒŒì¼ëª… ì²˜ë¦¬
            if (destFile.exists()) {
                String uniquePath = fileManager.getUniqueFileName(destFile.getAbsolutePath());
                destFile = new File(uniquePath);
                LoggerManager.logger("   â†’ ì¤‘ë³µ íŒŒì¼ëª… ì²˜ë¦¬: " + destFile.getName());
            }
            
            // íŒŒì¼ ë³µì‚¬
            boolean copySuccess = copyFileToDestination(tempFile, destFile);
            
            if (copySuccess) {
                String finalPath = destFile.getAbsolutePath();
                LoggerManager.logger("âœ… í¸ì§‘ í´ë” ì´ë™ ì™„ë£Œ: " + finalPath);
                LoggerManager.logger("   â†’ íŒŒì¼ í¬ê¸°: " + destFile.length() + " bytes");
                LoggerManager.logger("   â†’ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìœ„ì¹˜: /Audios/Edited/" + destFile.getName());
                return finalPath;
            } else {
                LoggerManager.logger("âŒ í¸ì§‘ í´ë”ë¡œ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨");
                return null;
            }
            
        } catch (Exception e) {
            LoggerManager.logger("âŒ í¸ì§‘ í´ë” ì´ë™ ì‹¤íŒ¨: " + e.getMessage());
            return null;
        }
    }
    
    /**
     * íŒŒì¼ ë³µì‚¬ í—¬í¼ ë©”ì„œë“œ
     */
    private boolean copyFileToDestination(File sourceFile, File destFile) {
        try (java.io.FileInputStream inputStream = new java.io.FileInputStream(sourceFile);
             java.io.FileOutputStream outputStream = new java.io.FileOutputStream(destFile)) {
            
            byte[] buffer = new byte[8 * 1024]; // 8KB ë²„í¼
            int bytesRead;
            long totalBytes = 0;
            
            while ((bytesRead = inputStream.read(buffer)) != -1) {
                outputStream.write(buffer, 0, bytesRead);
                totalBytes += bytesRead;
            }
            
            outputStream.flush();
            LoggerManager.logger("   â†’ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ: " + totalBytes + " bytes");
            return true;
            
        } catch (java.io.IOException e) {
            LoggerManager.logger("   â†’ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨: " + e.getMessage());
            return false;
        }
    }
    
    /**
     * MediaStore APIë¥¼ ì‚¬ìš©í•˜ì—¬ Downloads í´ë”ì— ì €ì¥ (Android 10+)
     */
    private String moveToDownloadsWithMediaStore(File sourceFile, String fileName) {
        try {
            android.content.ContentValues values = new android.content.ContentValues();
            values.put(android.provider.MediaStore.MediaColumns.DISPLAY_NAME, fileName);
            values.put(android.provider.MediaStore.MediaColumns.RELATIVE_PATH, 
                      android.os.Environment.DIRECTORY_DOWNLOADS + "/Audios");
            
            // MIME íƒ€ì… ì„¤ì •
            String mimeType = getMimeTypeFromFileName(fileName);
            values.put(android.provider.MediaStore.MediaColumns.MIME_TYPE, mimeType);
            
            // API 29+ì—ì„œ íŒŒì¼ ëŒ€ê¸° ìƒíƒœë¡œ ì„¤ì •
            values.put(android.provider.MediaStore.MediaColumns.IS_PENDING, 1);
            
            // MediaStoreì— íŒŒì¼ ë“±ë¡
            android.net.Uri externalUri = context.getContentResolver().insert(
                android.provider.MediaStore.Downloads.EXTERNAL_CONTENT_URI, values);
            
            if (externalUri == null) {
                throw new java.io.IOException("MediaStore URI ìƒì„± ì‹¤íŒ¨");
            }
            
            // íŒŒì¼ ë‚´ìš© ë³µì‚¬
            try (java.io.FileInputStream inputStream = new java.io.FileInputStream(sourceFile);
                 java.io.OutputStream outputStream = context.getContentResolver().openOutputStream(externalUri)) {
                
                if (outputStream == null) {
                    throw new java.io.IOException("OutputStream ìƒì„± ì‹¤íŒ¨");
                }
                
                byte[] buffer = new byte[8 * 1024];
                int bytesRead;
                long totalBytes = 0;
                
                while ((bytesRead = inputStream.read(buffer)) != -1) {
                    outputStream.write(buffer, 0, bytesRead);
                    totalBytes += bytesRead;
                }
                
                outputStream.flush();
                LoggerManager.logger("ğŸ“ MediaStore íŒŒì¼ ë³µì‚¬ ì™„ë£Œ: " + totalBytes + " bytes");
            }
            
            // ëŒ€ê¸° ìƒíƒœ í•´ì œ (íŒŒì¼ ì™„ì„±)
            values.clear();
            values.put(android.provider.MediaStore.MediaColumns.IS_PENDING, 0);
            context.getContentResolver().update(externalUri, values, null, null);
            
            // ì‹¤ì œ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ ì‹œë„
            String realPath = getRealPathFromMediaStoreUri(externalUri);
            if (realPath != null) {
                LoggerManager.logger("âœ… Downloads/Audios í´ë” ì €ì¥ ì™„ë£Œ: " + realPath);
                return realPath;
            } else {
                LoggerManager.logger("âœ… Downloads/Audios í´ë” ì €ì¥ ì™„ë£Œ (URI): " + externalUri.toString());
                return "/storage/emulated/0/Download/Audios/" + fileName; // ì‚¬ìš©ì ì•ˆë‚´ìš© ê²½ë¡œ
            }
            
        } catch (Exception e) {
            LoggerManager.logger("âŒ MediaStore ì €ì¥ ì‹¤íŒ¨: " + e.getMessage());
            return null;
        }
    }
    
    /**
     * ë ˆê±°ì‹œ ë°©ì‹ìœ¼ë¡œ Downloads í´ë”ì— ì €ì¥ (Android 9 ì´í•˜)
     */
    private String moveToDownloadsLegacy(File sourceFile, String fileName) {
        try {
            File downloadsDir = android.os.Environment.getExternalStoragePublicDirectory(
                android.os.Environment.DIRECTORY_DOWNLOADS);
            File audiosDir = new File(downloadsDir, "Audios");
            
            if (!audiosDir.exists()) {
                audiosDir.mkdirs();
            }
            
            File destFile = new File(audiosDir, fileName);
            
            // íŒŒì¼ ë³µì‚¬
            try (java.io.FileInputStream inputStream = new java.io.FileInputStream(sourceFile);
                 java.io.FileOutputStream outputStream = new java.io.FileOutputStream(destFile)) {
                
                byte[] buffer = new byte[8 * 1024];
                int bytesRead;
                
                while ((bytesRead = inputStream.read(buffer)) != -1) {
                    outputStream.write(buffer, 0, bytesRead);
                }
                
                outputStream.flush();
            }
            
            // ë¯¸ë””ì–´ ìŠ¤ìº” ìš”ì²­ (ê°¤ëŸ¬ë¦¬ ì¸ì‹)
            android.content.Intent mediaScanIntent = new android.content.Intent(
                android.content.Intent.ACTION_MEDIA_SCANNER_SCAN_FILE);
            mediaScanIntent.setData(android.net.Uri.fromFile(destFile));
            context.sendBroadcast(mediaScanIntent);
            
            LoggerManager.logger("âœ… Downloads/Audios í´ë” ì €ì¥ ì™„ë£Œ (ë ˆê±°ì‹œ): " + destFile.getAbsolutePath());
            return destFile.getAbsolutePath();
            
        } catch (Exception e) {
            LoggerManager.logger("âŒ ë ˆê±°ì‹œ ì €ì¥ ì‹¤íŒ¨: " + e.getMessage());
            return null;
        }
    }
    
    /**
     * íŒŒì¼ëª…ì—ì„œ MIME íƒ€ì… ì¶”ì¶œ
     */
    private String getMimeTypeFromFileName(String fileName) {
        if (fileName == null) return "audio/mpeg";
        
        String extension = fileName.toLowerCase();
        if (extension.endsWith(".m4a")) return "audio/mp4";
        if (extension.endsWith(".webm")) return "audio/webm";
        if (extension.endsWith(".mp3")) return "audio/mpeg";
        if (extension.endsWith(".wav")) return "audio/wav";
        if (extension.endsWith(".aac")) return "audio/aac";
        
        return "audio/mpeg"; // ê¸°ë³¸ê°’
    }
    
    /**
     * MediaStore URIì—ì„œ ì‹¤ì œ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
     */
    private String getRealPathFromMediaStoreUri(android.net.Uri uri) {
        try {
            String[] projection = {android.provider.MediaStore.MediaColumns.DATA};
            android.database.Cursor cursor = context.getContentResolver().query(
                uri, projection, null, null, null);
                
            if (cursor != null && cursor.moveToFirst()) {
                int columnIndex = cursor.getColumnIndexOrThrow(
                    android.provider.MediaStore.MediaColumns.DATA);
                String path = cursor.getString(columnIndex);
                cursor.close();
                return path;
            }
            
            if (cursor != null) {
                cursor.close();
            }
            
        } catch (Exception e) {
            LoggerManager.logger("ì‹¤ì œ ê²½ë¡œ ì¶”ì¶œ ì‹¤íŒ¨: " + e.getMessage());
        }
        
        return null;
    }
    
    /**
     * ExecutorService ìƒíƒœ í™•ì¸ ë° ì¬ìƒì„± (RejectedExecutionException ë°©ì§€)
     */
    private void ensureExecutorServiceReady() {
        if (executorService == null || executorService.isShutdown() || executorService.isTerminated()) {
            LoggerManager.logger("ğŸ”„ ExecutorService ì¬ìƒì„± í•„ìš”");
            LoggerManager.logger("   â†’ í˜„ì¬ ìƒíƒœ: " + (executorService == null ? "null" : 
                (executorService.isShutdown() ? "shutdown" : 
                (executorService.isTerminated() ? "terminated" : "active"))));
            
            executorService = Executors.newSingleThreadExecutor();
            LoggerManager.logger("âœ… ExecutorService ì¬ìƒì„± ì™„ë£Œ - ìƒˆë¡œìš´ ì‘ì—… ì¤€ë¹„ë¨");
        } else {
            LoggerManager.logger("â„¹ï¸ ExecutorService ìƒíƒœ ì •ìƒ - ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©");
        }
    }
    
    /**
     * ë¦¬ì†ŒìŠ¤ ì •ë¦¬
     */
    public void cleanup() {
        try {
            // ì§„í–‰ ì¤‘ì¸ ì‘ì—… ì·¨ì†Œ
            cancelTrimming();
            
            // ExecutorService ì¢…ë£Œ
            if (executorService != null && !executorService.isShutdown()) {
                executorService.shutdown();
            }
            
            // ì„ì‹œ íŒŒì¼ ì •ë¦¬
            if (context != null) {
                // ì…ë ¥ìš© ì„ì‹œ íŒŒì¼ ì •ë¦¬
                File tempInputDir = new File(context.getCacheDir(), "temp_audio_trimmer");
                clearTempDirectory(tempInputDir);
                
                // ì¶œë ¥ìš© ì„ì‹œ íŒŒì¼ ì •ë¦¬
                File tempOutputDir = new File(context.getCacheDir(), "temp_output");
                clearTempDirectory(tempOutputDir);
            }
            
            LoggerManager.logger("NativeAudioTrimManager ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì™„ë£Œ");
            
        } catch (Exception e) {
            LoggerManager.logger("NativeAudioTrimManager ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ì‹¤íŒ¨: " + e.getMessage());
        }
    }
    
    /**
     * ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
     */
    private void clearTempDirectory(File tempDir) {
        try {
            if (tempDir.exists()) {
                File[] tempFiles = tempDir.listFiles();
                if (tempFiles != null) {
                    for (File file : tempFiles) {
                        file.delete();
                    }
                }
                tempDir.delete();
            }
        } catch (Exception e) {
            LoggerManager.logger("ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬ ì‹¤íŒ¨: " + tempDir.getName() + " - " + e.getMessage());
        }
    }
    
    // ================ ë¦¬íŒ©í† ë§ëœ ê°œë³„ STEP ë©”ì„œë“œë“¤ ================
    
    /**
     * STEP 1: URIë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ë³µì‚¬ (Scoped Storage í˜¸í™˜)
     */
    private File createTempInputFile(Uri sourceUri) throws IOException {
        LoggerManager.logger("ğŸ“ STEP 1: URIë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ë³µì‚¬ ì¤‘...");
        LoggerManager.logger("   â†’ ì›ë³¸ URI: " + sourceUri.toString());
        
        long startTime = System.currentTimeMillis();
        File tempInputFile = createTempFileFromUri(sourceUri);
        long copyTime = System.currentTimeMillis() - startTime;
        
        if (tempInputFile == null) {
            LoggerManager.logger("âŒ STEP 1 ì‹¤íŒ¨: ì„ì‹œ íŒŒì¼ ìƒì„± ì‹¤íŒ¨");
            throw new IOException("URIë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ë³µì‚¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        
        LoggerManager.logger("âœ… STEP 1 ì™„ë£Œ: ì„ì‹œ ì…ë ¥ íŒŒì¼ ìƒì„± ì„±ê³µ");
        LoggerManager.logger("   â†’ ì„ì‹œ íŒŒì¼ ê²½ë¡œ: " + tempInputFile.getAbsolutePath());
        LoggerManager.logger("   â†’ íŒŒì¼ í¬ê¸°: " + tempInputFile.length() + " bytes");
        LoggerManager.logger("   â†’ ë³µì‚¬ ì‹œê°„: " + copyTime + "ms");
        
        return tempInputFile;
    }
    
    /**
     * STEP 2: ì„ì‹œ ì¶œë ¥ ë””ë ‰í† ë¦¬ ì„¤ì •
     */
    private File setupTempOutputDirectory(String outputFileName, AudioFormat format) throws IOException {
        LoggerManager.logger("ğŸ“‚ STEP 2: ì„ì‹œ ì¶œë ¥ ë””ë ‰í† ë¦¬ ì„¤ì • ì¤‘...");
        File tempOutputDir = new File(context.getCacheDir(), "temp_output");
        LoggerManager.logger("   â†’ ì„ì‹œ ì¶œë ¥ ë””ë ‰í† ë¦¬: " + tempOutputDir.getAbsolutePath());
        
        // íŒŒì¼ ì‹œìŠ¤í…œ ìƒíƒœ ìƒì„¸ í™•ì¸
        LoggerManager.logger("ğŸ” íŒŒì¼ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸:");
        LoggerManager.logger("   â†’ Cache ë””ë ‰í† ë¦¬: " + context.getCacheDir().getAbsolutePath());
        LoggerManager.logger("   â†’ Cache ë””ë ‰í† ë¦¬ ì¡´ì¬: " + context.getCacheDir().exists());
        LoggerManager.logger("   â†’ Cache ë””ë ‰í† ë¦¬ ì“°ê¸° ê°€ëŠ¥: " + context.getCacheDir().canWrite());
        LoggerManager.logger("   â†’ Cache ë””ë ‰í† ë¦¬ ì‚¬ìš© ê°€ëŠ¥ ê³µê°„: " + context.getCacheDir().getFreeSpace() + " bytes (" + (context.getCacheDir().getFreeSpace()/1024/1024) + " MB)");
        
        if (!tempOutputDir.exists()) {
            LoggerManager.logger("   â†’ temp_output ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ - ìƒì„± ì‹œë„");
            boolean dirCreated = tempOutputDir.mkdirs();
            LoggerManager.logger("   â†’ ë””ë ‰í† ë¦¬ ìƒì„±: " + (dirCreated ? "ì„±ê³µ" : "ì‹¤íŒ¨"));
            
            if (!dirCreated) {
                LoggerManager.logger("âŒ STEP 2 ì‹¤íŒ¨: ì„ì‹œ ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„± ì‹¤íŒ¨");
                LoggerManager.logger("   â†’ ê°€ëŠ¥í•œ ì›ì¸:");
                LoggerManager.logger("     - ì €ì¥ ê³µê°„ ë¶€ì¡±: ì‚¬ìš© ê°€ëŠ¥ ê³µê°„ " + (context.getCacheDir().getFreeSpace()/1024/1024) + "MB");
                LoggerManager.logger("     - ê¶Œí•œ ë¬¸ì œ: Cache ë””ë ‰í† ë¦¬ ì“°ê¸° ê¶Œí•œ " + context.getCacheDir().canWrite());
                LoggerManager.logger("     - ì‹œìŠ¤í…œ ì˜¤ë¥˜: íŒŒì¼ ì‹œìŠ¤í…œ ë¬¸ì œ");
                throw new IOException("ì„ì‹œ ì¶œë ¥ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        } else {
            LoggerManager.logger("   â†’ ë””ë ‰í† ë¦¬ ì´ë¯¸ ì¡´ì¬í•¨");
            LoggerManager.logger("   â†’ ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì“°ê¸° ê°€ëŠ¥: " + tempOutputDir.canWrite());
            
            // ê¸°ì¡´ íŒŒì¼ ëª©ë¡ í™•ì¸
            File[] existingFiles = tempOutputDir.listFiles();
            if (existingFiles != null) {
                LoggerManager.logger("   â†’ ê¸°ì¡´ ì„ì‹œ íŒŒì¼ ìˆ˜: " + existingFiles.length + "ê°œ");
                if (existingFiles.length > 10) {
                    LoggerManager.logger("   âš ï¸ ì„ì‹œ íŒŒì¼ì´ ë§ìŒ - ì •ë¦¬ ê¶Œì¥");
                }
            } else {
                LoggerManager.logger("   âš ï¸ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");
            }
        }
        
        // íŒŒì¼ëª… ì²˜ë¦¬ ë° ê²€ì¦
        String fileName = processFileName(outputFileName, format);
        File tempOutputFile = new File(tempOutputDir, fileName);
        String tempOutputPath = tempOutputFile.getAbsolutePath();
        
        LoggerManager.logger("âœ… STEP 2 ì™„ë£Œ: ì„ì‹œ ì¶œë ¥ íŒŒì¼ ê²½ë¡œ ìƒì„±");
        LoggerManager.logger("   â†’ ì„ì‹œ ì¶œë ¥ íŒŒì¼: " + tempOutputPath);
        LoggerManager.logger("   â†’ ì „ì²´ ê²½ë¡œ ê¸¸ì´: " + tempOutputPath.length() + " chars");
        
        return tempOutputFile;
    }
    
    /**
     * íŒŒì¼ëª… ì²˜ë¦¬ ë° ê²€ì¦ í—¬í¼ ë©”ì„œë“œ
     */
    private String processFileName(String outputFileName, AudioFormat format) {
        String fileName = outputFileName;
        LoggerManager.logger("   â†’ ì›ë³¸ íŒŒì¼ëª…: " + outputFileName);
        
        // í•œê¸€ íŒŒì¼ëª… ì¸ì½”ë”© ê²€ì¦
        LoggerManager.logger("ğŸ”¤ í•œê¸€ íŒŒì¼ëª… ì²˜ë¦¬ ë¶„ì„:");
        try {
            byte[] utf8Bytes = fileName.getBytes("UTF-8");
            String utf8Test = new String(utf8Bytes, "UTF-8");
            LoggerManager.logger("   â†’ UTF-8 ì¸ì½”ë”© í…ŒìŠ¤íŠ¸: " + utf8Test.equals(fileName) + " (ì›ë³¸ê³¼ ë™ì¼)");
            LoggerManager.logger("   â†’ UTF-8 ë°”ì´íŠ¸ ìˆ˜: " + utf8Bytes.length + " bytes");
            LoggerManager.logger("   â†’ ë¬¸ì ìˆ˜: " + fileName.length() + " chars");
            
            // íŠ¹ìˆ˜ë¬¸ì í¬í•¨ ì—¬ë¶€ í™•ì¸
            boolean hasSpecialChars = !fileName.matches("^[a-zA-Z0-9ê°€-í£._-]+$");
            LoggerManager.logger("   â†’ íŠ¹ìˆ˜ë¬¸ì í¬í•¨: " + hasSpecialChars);
            if (hasSpecialChars) {
                LoggerManager.logger("   â†’ íŒŒì¼ëª…ì— íŠ¹ìˆ˜ë¬¸ì í¬í•¨ - íŒŒì¼ ì‹œìŠ¤í…œ í˜¸í™˜ì„± ì£¼ì˜ í•„ìš”");
            }
        } catch (Exception e) {
            LoggerManager.logger("   âš ï¸ íŒŒì¼ëª… ì¸ì½”ë”© ê²€ì¦ ì‹¤íŒ¨: " + e.getMessage());
        }
        
        // ê¸°ì¡´ í™•ì¥ì ì œê±°
        int lastDotIndex = fileName.lastIndexOf('.');
        if (lastDotIndex > 0) {
            fileName = fileName.substring(0, lastDotIndex);
            LoggerManager.logger("   â†’ í™•ì¥ì ì œê±°: " + outputFileName + " â†’ " + fileName);
        }
        
        // ìƒˆë¡œìš´ í™•ì¥ì ì¶”ê°€
        fileName += format.getExtension();
        LoggerManager.logger("   â†’ ìµœì¢… íŒŒì¼ëª…: " + fileName);
        
        // íŒŒì¼ëª… ê¸¸ì´ í™•ì¸ (íŒŒì¼ ì‹œìŠ¤í…œ ì œí•œ)
        if (fileName.length() > 100) {
            LoggerManager.logger("   âš ï¸ íŒŒì¼ëª…ì´ ë§¤ìš° ê¹€ (" + fileName.length() + "ì) - ì¼ë¶€ íŒŒì¼ì‹œìŠ¤í…œì—ì„œ ë¬¸ì œ ê°€ëŠ¥");
        }
        
        return fileName;
    }
    
    /**
     * STEP 3: MediaExtractor ì„¤ì •
     */
    private MediaExtractor setupMediaExtractor(File tempInputFile) throws IOException, IllegalStateException {
        LoggerManager.logger("ğŸµ STEP 3: MediaExtractor ì„¤ì • ì¤‘...");
        
        try {
            MediaExtractor extractor = new MediaExtractor();
            LoggerManager.logger("   â†’ MediaExtractor ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ");
            
            extractor.setDataSource(tempInputFile.getAbsolutePath());
            LoggerManager.logger("   â†’ ë°ì´í„° ì†ŒìŠ¤ ì„¤ì • ì™„ë£Œ: " + tempInputFile.getAbsolutePath());
            
            LoggerManager.logger("âœ… STEP 3 ì™„ë£Œ: MediaExtractor ì„¤ì • ì„±ê³µ");
            return extractor;
            
        } catch (IOException e) {
            LoggerManager.logger("âŒ STEP 3 ì‹¤íŒ¨: MediaExtractor ì„¤ì • ì¤‘ IOException: " + e.getMessage());
            throw e;
        } catch (Exception e) {
            LoggerManager.logger("âŒ STEP 3 ì‹¤íŒ¨: MediaExtractor ì„¤ì • ì¤‘ ì˜ˆì™¸: " + e.getClass().getSimpleName() + " - " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * STEP 4: ì˜¤ë””ì˜¤ íŠ¸ë™ ì„ íƒ ë° í¬ë§· ë¶„ì„
     */
    private AudioTrackInfo analyzeAudioTrack(MediaExtractor extractor, long startTimeMs, long endTimeMs, AudioFormat format) throws IllegalStateException {
        LoggerManager.logger("ğŸ¯ STEP 4: ì˜¤ë””ì˜¤ íŠ¸ë™ ì„ íƒ ë° í¬ë§· ë¶„ì„ ì¤‘...");
        
        try {
            // ì˜¤ë””ì˜¤ íŠ¸ë™ ì°¾ê¸°
            LoggerManager.logger("   â†’ ì˜¤ë””ì˜¤ íŠ¸ë™ ê²€ìƒ‰ ì¤‘...");
            int audioTrackIndex = findAudioTrack(extractor);
            
            if (audioTrackIndex < 0) {
                LoggerManager.logger("âŒ STEP 4 ì‹¤íŒ¨: ì˜¤ë””ì˜¤ íŠ¸ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ");
                throw new IllegalStateException("ì˜¤ë””ì˜¤ íŠ¸ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            LoggerManager.logger("   â†’ ì˜¤ë””ì˜¤ íŠ¸ë™ ì¸ë±ìŠ¤: " + audioTrackIndex);
            
            extractor.selectTrack(audioTrackIndex);
            LoggerManager.logger("   â†’ ì˜¤ë””ì˜¤ íŠ¸ë™ " + audioTrackIndex + " ì„ íƒ ì™„ë£Œ");
            
            MediaFormat audioFormat = extractor.getTrackFormat(audioTrackIndex);
            LoggerManager.logger("   â†’ MediaFormat ì¶”ì¶œ ì™„ë£Œ");
            
            // ì´ ê¸°ê°„ ê³„ì‚° (ì§„í–‰ë¥ ìš©)
            if (audioFormat.containsKey(MediaFormat.KEY_DURATION)) {
                totalDurationUs = audioFormat.getLong(MediaFormat.KEY_DURATION);
                LoggerManager.logger("   â†’ ì˜¤ë””ì˜¤ ì´ ê¸¸ì´: " + totalDurationUs + " Î¼s (" + (totalDurationUs/1000) + " ms)");
            } else {
                totalDurationUs = 0;
                LoggerManager.logger("âš ï¸ ì£¼ì˜: ì˜¤ë””ì˜¤ ê¸¸ì´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ì§„í–‰ë¥  í‘œì‹œ ì œí•œë¨");
            }
            
            processedDurationUs = 0;
            LoggerManager.logger("   â†’ ì²˜ë¦¬ëœ ê¸¸ì´ ì´ˆê¸°í™”: 0 Î¼s");
            
            // ìë¥´ê¸° êµ¬ê°„ ë¡œê¹…
            logTrimSegment(startTimeMs, endTimeMs);
            
            // ì¶œë ¥ í¬ë§· ì •ë³´ ë¡œê¹…
            logOutputFormat(format);
            
            // ì˜¤ë””ì˜¤ í¬ë§· ìƒì„¸ ì •ë³´ ë¡œê¹…
            LoggerManager.logger("ğŸ“Š ì…ë ¥ ì˜¤ë””ì˜¤ í¬ë§· ìƒì„¸ ë¶„ì„:");
            logDetailedAudioFormat(audioFormat);
            
            LoggerManager.logger("âœ… STEP 4 ì™„ë£Œ: ì˜¤ë””ì˜¤ ë¶„ì„ ë° ì„¤ì • ì„±ê³µ");
            
            return new AudioTrackInfo(audioTrackIndex, audioFormat);
            
        } catch (Exception e) {
            LoggerManager.logger("âŒ STEP 4 ì‹¤íŒ¨: ì˜¤ë””ì˜¤ íŠ¸ë™ ì„ íƒ/ë¶„ì„ ì¤‘ ì˜ˆì™¸: " + e.getClass().getSimpleName() + " - " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * ìë¥´ê¸° êµ¬ê°„ ì •ë³´ ë¡œê¹… í—¬í¼ ë©”ì„œë“œ
     */
    private void logTrimSegment(long startTimeMs, long endTimeMs) {
        long trimStartUs = startTimeMs * 1000;
        long trimEndUs = endTimeMs * 1000;
        long trimDurationUs = trimEndUs - trimStartUs;
        
        LoggerManager.logger("ğŸ“ ìë¥´ê¸° êµ¬ê°„ ë¶„ì„:");
        LoggerManager.logger("   â†’ ì‹œì‘: " + startTimeMs + "ms (" + trimStartUs + " Î¼s)");
        LoggerManager.logger("   â†’ ë: " + endTimeMs + "ms (" + trimEndUs + " Î¼s)");
        LoggerManager.logger("   â†’ ìë¥¼ ê¸¸ì´: " + (endTimeMs - startTimeMs) + "ms (" + trimDurationUs + " Î¼s)");
        
        if (totalDurationUs > 0) {
            double trimRatio = (double)trimDurationUs / totalDurationUs * 100;
            LoggerManager.logger("   â†’ ì „ì²´ ëŒ€ë¹„ ë¹„ìœ¨: " + String.format("%.1f%%", trimRatio));
        }
    }
    
    /**
     * ì¶œë ¥ í¬ë§· ì •ë³´ ë¡œê¹… í—¬í¼ ë©”ì„œë“œ
     */
    private void logOutputFormat(AudioFormat format) {
        LoggerManager.logger("ğŸµ ì¶œë ¥ í¬ë§· ì„¤ì •:");
        LoggerManager.logger("   â†’ í¬ë§·: " + format.name());
        LoggerManager.logger("   â†’ MIME íƒ€ì…: " + format.getMimeType()); 
        LoggerManager.logger("   â†’ í™•ì¥ì: " + format.getExtension());
    }
    
    /**
     * STEP 5: MediaMuxer ì„¤ì • ë° íŠ¸ë™ ì¶”ê°€
     */
    private MuxerSetupResult setupMediaMuxer(File tempOutputFile, MediaFormat audioFormat, AudioFormat format) throws Exception {
        LoggerManager.logger("ğŸ¬ STEP 5: MediaMuxer ì„¤ì • ë° íŠ¸ë™ ì¶”ê°€ ì¤‘...");
        String tempOutputPath = tempOutputFile.getAbsolutePath();
        LoggerManager.logger("   â†’ ì„ì‹œ ì¶œë ¥ íŒŒì¼: " + tempOutputPath);
        LoggerManager.logger("   â†’ Muxer í¬ë§·: " + format.getMuxerFormat() + " (" + format.name() + ")");
        
        // MediaMuxer ìƒì„± ì „ íŒŒì¼ ìƒíƒœ í™•ì¸
        logPreMuxerFileState(tempOutputFile, tempOutputPath);
        
        try {
            LoggerManager.logger("ğŸ”¨ MediaMuxer ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œë„...");
            MediaMuxer muxer = new MediaMuxer(tempOutputPath, format.getMuxerFormat());
            LoggerManager.logger("   âœ… MediaMuxer ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì„±ê³µ");
            
            // MediaMuxer ìƒì„± í›„ íŒŒì¼ ìƒíƒœ í™•ì¸
            logPostMuxerCreationState(tempOutputFile);
            
            // í¬ë§· í˜¸í™˜ì„± ê²€ì¦ ë° íŠ¸ë™ ì¶”ê°€
            LoggerManager.logger("   â†’ í¬ë§· í˜¸í™˜ì„± ê²€ì¦ ë° íŠ¸ë™ ì¶”ê°€ ì‹œì‘...");
            int muxerTrackIndex = addTrackWithCompatibilityCheck(muxer, audioFormat, format);
            
            if (muxerTrackIndex < 0) {
                LoggerManager.logger("âŒ STEP 5 ì‹¤íŒ¨: MediaMuxer íŠ¸ë™ ì¶”ê°€ ì‹¤íŒ¨ (ì¸ë±ìŠ¤: " + muxerTrackIndex + ")");
                throw new IllegalStateException("MediaMuxerì— ì˜¤ë””ì˜¤ íŠ¸ë™ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í¬ë§· í˜¸í™˜ì„±ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
            LoggerManager.logger("   â†’ íŠ¸ë™ ì¶”ê°€ ì„±ê³µ (íŠ¸ë™ ì¸ë±ìŠ¤: " + muxerTrackIndex + ")");
            
            // íŠ¸ë™ ì¶”ê°€ í›„ íŒŒì¼ ìƒíƒœ í™•ì¸
            logPostTrackAdditionState(tempOutputFile);
            
            // MediaMuxer ì‹œì‘
            startMediaMuxer(muxer, tempOutputFile);
            
            LoggerManager.logger("âœ… STEP 5 ì™„ë£Œ: MediaMuxer ì„¤ì • ë° ì‹œì‘ ì„±ê³µ");
            return new MuxerSetupResult(muxer, muxerTrackIndex);
            
        } catch (IOException e) {
            LoggerManager.logger("âŒ STEP 5 ì‹¤íŒ¨: MediaMuxer ìƒì„± ì¤‘ IOException: " + e.getMessage());
            throw e;
        } catch (Exception e) {
            LoggerManager.logger("âŒ STEP 5 ì‹¤íŒ¨: MediaMuxer ì„¤ì • ì¤‘ ì˜ˆì™¸: " + e.getClass().getSimpleName() + " - " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * MediaMuxer ìƒì„± ì „ íŒŒì¼ ìƒíƒœ ë¡œê¹… í—¬í¼ ë©”ì„œë“œ
     */
    private void logPreMuxerFileState(File tempOutputFile, String tempOutputPath) {
        LoggerManager.logger("ğŸ“‹ MediaMuxer ìƒì„± ì „ íŒŒì¼ ìƒíƒœ:");
        LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ ê²½ë¡œ: " + tempOutputPath);
        LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ ì¡´ì¬: " + tempOutputFile.exists());
        if (tempOutputFile.getParentFile() != null) {
            LoggerManager.logger("   â†’ ë¶€ëª¨ ë””ë ‰í† ë¦¬ ì¡´ì¬: " + tempOutputFile.getParentFile().exists());
            LoggerManager.logger("   â†’ ë¶€ëª¨ ë””ë ‰í† ë¦¬ ì“°ê¸° ê°€ëŠ¥: " + tempOutputFile.getParentFile().canWrite());
        }
    }
    
    /**
     * MediaMuxer ìƒì„± í›„ íŒŒì¼ ìƒíƒœ ë¡œê¹… í—¬í¼ ë©”ì„œë“œ
     */
    private void logPostMuxerCreationState(File tempOutputFile) {
        LoggerManager.logger("ğŸ“‹ MediaMuxer ìƒì„± í›„ íŒŒì¼ ìƒíƒœ:");
        LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ ì¡´ì¬: " + tempOutputFile.exists());
        if (tempOutputFile.exists()) {
            LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ í¬ê¸°: " + tempOutputFile.length() + " bytes");
            LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ ì½ê¸° ê°€ëŠ¥: " + tempOutputFile.canRead());
            LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ ì“°ê¸° ê°€ëŠ¥: " + tempOutputFile.canWrite());
        }
    }
    
    /**
     * íŠ¸ë™ ì¶”ê°€ í›„ íŒŒì¼ ìƒíƒœ ë¡œê¹… í—¬í¼ ë©”ì„œë“œ
     */
    private void logPostTrackAdditionState(File tempOutputFile) {
        LoggerManager.logger("ğŸ“‹ íŠ¸ë™ ì¶”ê°€ í›„ íŒŒì¼ ìƒíƒœ:");
        LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ ì¡´ì¬: " + tempOutputFile.exists());
        if (tempOutputFile.exists()) {
            LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ í¬ê¸°: " + tempOutputFile.length() + " bytes");
        }
    }
    
    /**
     * MediaMuxer ì‹œì‘ í—¬í¼ ë©”ì„œë“œ
     */
    private void startMediaMuxer(MediaMuxer muxer, File tempOutputFile) {
        LoggerManager.logger("   â†’ MediaMuxer ì‹œì‘ ì¤‘...");
        try {
            muxer.start();
            muxerState = MuxerState.STARTED;
            muxerNeedsStop = true; // start()ê°€ ì„±ê³µí•˜ë©´ ë‚˜ì¤‘ì— stop() í•„ìš”
            LoggerManager.logger("   âœ… MediaMuxer ì‹œì‘ ì„±ê³µ");
            LoggerManager.logger("   â†’ ìƒíƒœ: " + muxerState);
            
            // MediaMuxer ì‹œì‘ í›„ íŒŒì¼ ìƒíƒœ í™•ì¸
            LoggerManager.logger("ğŸ“‹ MediaMuxer ì‹œì‘ í›„ íŒŒì¼ ìƒíƒœ:");
            LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ ì¡´ì¬: " + tempOutputFile.exists());
            if (tempOutputFile.exists()) {
                LoggerManager.logger("   â†’ ì¶œë ¥ íŒŒì¼ í¬ê¸°: " + tempOutputFile.length() + " bytes");
                LoggerManager.logger("   â†’ íŒŒì¼ í—¤ë”ê°€ ìƒì„±ë¨ (MediaMuxer ì¤€ë¹„ ì™„ë£Œ)");
            }
            
        } catch (Exception e) {
            LoggerManager.logger("âŒ MediaMuxer ì‹œì‘ ì¤‘ ì˜ˆì™¸: " + e.getClass().getSimpleName() + " - " + e.getMessage());
            LoggerManager.logger("   â†’ MediaMuxer ì‹œì‘ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„:");
            LoggerManager.logger("     - íŒŒì¼ ê²½ë¡œ ë¬¸ì œ: " + tempOutputFile.getAbsolutePath());
            if (tempOutputFile.getParentFile() != null) {
                LoggerManager.logger("     - ë””ìŠ¤í¬ ê³µê°„ ë¬¸ì œ: " + (tempOutputFile.getParentFile().getFreeSpace()/1024/1024) + "MB ë‚¨ìŒ");
                LoggerManager.logger("     - ê¶Œí•œ ë¬¸ì œ: ì“°ê¸° ê¶Œí•œ " + tempOutputFile.getParentFile().canWrite());
            }
            muxerState = MuxerState.STOPPED; // ì‹œì‘ ì‹¤íŒ¨ ì‹œ ì •ì§€ ìƒíƒœë¡œ ì„¤ì •
            throw new RuntimeException("MediaMuxer ì‹œì‘ ì‹¤íŒ¨", e);
        }
    }
    
    /**
     * STEP 6: ì˜¤ë””ì˜¤ ë°ì´í„° ìë¥´ê¸° ë° ë³µì‚¬
     */
    private boolean copyAndTrimAudioData(MediaExtractor extractor, MediaMuxer muxer, int muxerTrackIndex, long startTimeUs, long endTimeUs) throws InterruptedException {
        LoggerManager.logger("ğŸ”„ STEP 6: ì˜¤ë””ì˜¤ ë°ì´í„° ìë¥´ê¸° ë° ë³µì‚¬ ì‹œì‘...");
        LoggerManager.logger("   â†’ ìë¥´ê¸° êµ¬ê°„: " + startTimeUs + " ~ " + endTimeUs + " Î¼s");
        LoggerManager.logger("   â†’ ëŒ€ìƒ íŠ¸ë™: " + muxerTrackIndex);
        
        long copyStartTime = System.currentTimeMillis();
        boolean copySuccess = trimAndCopyAudioTrack(extractor, muxer, muxerTrackIndex, startTimeUs, endTimeUs);
        long copyDuration = System.currentTimeMillis() - copyStartTime;
        
        if (!copySuccess) {
            LoggerManager.logger("âŒ STEP 6 ì‹¤íŒ¨: ì˜¤ë””ì˜¤ ë°ì´í„° ë³µì‚¬ ì‹¤íŒ¨");
            LoggerManager.logger("âš ï¸ ë¶€ë¶„ ë°ì´í„°ë¼ë„ íŒŒì¼ ì™„ì„±ì„ ì‹œë„í•©ë‹ˆë‹¤ (MediaMuxer.stop() ê°•ì œ í˜¸ì¶œ)");
            
            // í•µì‹¬ ìˆ˜ì •: copySuccess=falseì—¬ë„ MediaMuxer.stop() í˜¸ì¶œí•´ì„œ íŒŒì¼ ì™„ì„±
            try {
                if (muxerState == MuxerState.STARTED && muxerNeedsStop) {
                    LoggerManager.logger("ğŸ”§ ê°•ì œ MediaMuxer.stop() í˜¸ì¶œ - ë¶€ë¶„ ë°ì´í„°ë¼ë„ íŒŒì¼ ì™„ì„±");
                    muxer.stop();
                    muxerState = MuxerState.STOPPED;
                    muxerNeedsStop = false;
                    LoggerManager.logger("âœ… ê°•ì œ stop() ì„±ê³µ - íŒŒì¼ í—¤ë” ì™„ì„±ë¨");
                }
            } catch (Exception stopEx) {
                LoggerManager.logger("âŒ ê°•ì œ stop() ì‹¤íŒ¨: " + stopEx.getMessage());
            }
            
            LoggerManager.logger("ğŸ” ë¶€ë¶„ ì™„ì„±ëœ íŒŒì¼ ê²€ì¦ ì‹œë„...");
        }
        
        // STEP 6 ì™„ë£Œ ìƒíƒœì— ë”°ë¥¸ ë¡œê¹…
        if (copySuccess) {
            LoggerManager.logger("âœ… STEP 6 ì™„ë£Œ: ì˜¤ë””ì˜¤ ë°ì´í„° ë³µì‚¬ ì„±ê³µ");
            LoggerManager.logger("   â†’ ë³µì‚¬ ì‹œê°„: " + copyDuration + "ms");
            LoggerManager.logger("   â†’ ì²˜ë¦¬ëœ ë°ì´í„°: " + processedDurationUs + " Î¼s");
            
            // ë°ì´í„° ì“°ê¸° ì™„ë£Œ
            LoggerManager.logger("ğŸ¯ ì˜¤ë””ì˜¤ ë°ì´í„° ì“°ê¸° ì™„ë£Œ - MediaMuxer ì •ì§€ ì¤€ë¹„");
            LoggerManager.logger("   â†’ ì²˜ë¦¬ëœ ë°ì´í„°: " + processedDurationUs + " Î¼s");
            LoggerManager.logger("   â†’ í˜„ì¬ ìƒíƒœ: " + muxerState);
        } else {
            LoggerManager.logger("âš ï¸ STEP 6 ë¶€ë¶„ ì™„ë£Œ: ì˜¤ë””ì˜¤ ë°ì´í„° ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒí–ˆìœ¼ë‚˜ ê°•ì œ ì™„ì„± ì‹œë„");
            LoggerManager.logger("   â†’ ë³µì‚¬ ì‹œê°„: " + copyDuration + "ms");
            LoggerManager.logger("   â†’ í˜„ì¬ ìƒíƒœ: " + muxerState);
            LoggerManager.logger("   â†’ ê²€ì¦ í†µê³¼ì‹œ ê³„ì† ì§„í–‰, ì‹¤íŒ¨ì‹œ ì‘ì—… ì¤‘ë‹¨");
        }
        
        return copySuccess;
    }
    
    /**
     * STEP 7: ì„ì‹œ íŒŒì¼ ìƒì„± ë° í’ˆì§ˆ ê²€ì¦
     */
    private void validateTrimmedFile(File tempOutputFile, boolean copySuccess) throws IOException {
        LoggerManager.logger("ğŸ“‹ STEP 7: ì„ì‹œ íŒŒì¼ ê²€ì¦ ì‹œì‘...");
        String tempOutputPath = tempOutputFile.getAbsolutePath();
        LoggerManager.logger("   â†’ ê²€ì¦ ëŒ€ìƒ: " + tempOutputPath);
        
        // MediaMuxer ì •ì§€ ì „ ë§ˆì§€ë§‰ íŒŒì¼ ìƒíƒœ í™•ì¸
        logPreValidationFileState(tempOutputFile);
        
        boolean tempFileVerification = verifyFinalOutputFile(tempOutputPath);
        if (!tempFileVerification) {
            if (copySuccess) {
                // copySuccess=trueì¸ë° ê²€ì¦ ì‹¤íŒ¨ â†’ ì¹˜ëª…ì  ì˜¤ë¥˜
                LoggerManager.logger("âŒ STEP 7 ì‹¤íŒ¨: ì„ì‹œ íŒŒì¼ ê²€ì¦ ì‹¤íŒ¨ (ì™„ì „ ë³µì‚¬ì˜€ìœ¼ë‚˜ ê²€ì¦ ì‹¤íŒ¨)");
                logValidationFailureDetails(tempOutputPath, tempOutputFile, true);
                throw new IOException("ì„ì‹œ íŒŒì¼ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: " + tempOutputPath);
            } else {
                // copySuccess=falseì¸ë° ê²€ì¦ ì‹¤íŒ¨ â†’ ì˜ˆìƒëœ ìƒí™©, ê²½ê³ ë¡œ ì²˜ë¦¬
                LoggerManager.logger("âš ï¸ STEP 7 ê²½ê³ : ë¶€ë¶„ ì™„ì„± íŒŒì¼ ê²€ì¦ ì‹¤íŒ¨ (ì˜ˆìƒëœ ìƒí™©)");
                logValidationFailureDetails(tempOutputPath, tempOutputFile, false);
                LoggerManager.logger("   â†’ ì´ ê²½ìš° ì›ë³¸ ë°ì´í„° ë¬¸ì œ ë˜ëŠ” í˜¸í™˜ì„± ë¬¸ì œì¼ ê°€ëŠ¥ì„± ë†’ìŒ");
                throw new IOException("ì˜¤ë””ì˜¤ ìë¥´ê¸° ì‹¤íŒ¨: ì›ë³¸ íŒŒì¼ í˜¸í™˜ì„± ë¬¸ì œ ë˜ëŠ” ë°ì´í„° ì†ìƒ ê°€ëŠ¥ì„±");
            }
        }
        
        LoggerManager.logger("âœ… STEP 7 ì™„ë£Œ: ì„ì‹œ íŒŒì¼ ê²€ì¦ ì„±ê³µ");
        LoggerManager.logger("   â†’ íŒŒì¼ í¬ê¸°: " + tempOutputFile.length() + " bytes");
        LoggerManager.logger("   â†’ íŒŒì¼ ìœ„ì¹˜: " + tempOutputPath);
        LoggerManager.logger("   â†’ ê²€ì¦ ê²°ê³¼: ì¬ìƒ ê°€ëŠ¥í•œ ì˜¤ë””ì˜¤ íŒŒì¼ í™•ì¸ë¨");
    }
    
    /**
     * ê²€ì¦ ì „ íŒŒì¼ ìƒíƒœ ë¡œê¹… í—¬í¼ ë©”ì„œë“œ
     */
    private void logPreValidationFileState(File tempOutputFile) {
        LoggerManager.logger("ğŸ“‹ MediaMuxer ì •ì§€ ì „ ìµœì¢… íŒŒì¼ ìƒíƒœ:");
        LoggerManager.logger("   â†’ íŒŒì¼ ì¡´ì¬: " + tempOutputFile.exists());
        if (tempOutputFile.exists()) {
            LoggerManager.logger("   â†’ íŒŒì¼ í¬ê¸°: " + tempOutputFile.length() + " bytes");
            LoggerManager.logger("   â†’ íŒŒì¼ ë§ˆì§€ë§‰ ìˆ˜ì •: " + new java.util.Date(tempOutputFile.lastModified()));
            LoggerManager.logger("   â†’ íŒŒì¼ ì½ê¸° ê°€ëŠ¥: " + tempOutputFile.canRead());
        } else {
            LoggerManager.logger("   âŒ ì„ì‹œ ì¶œë ¥ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ!");
            LoggerManager.logger("   â†’ MediaMuxerê°€ íŒŒì¼ì„ ìƒì„±í•˜ì§€ ëª»í–ˆê±°ë‚˜ ë‹¤ë¥¸ ìœ„ì¹˜ì— ìƒì„±ë¨");
            if (tempOutputFile.getParentFile() != null) {
                LoggerManager.logger("   â†’ ë¶€ëª¨ ë””ë ‰í† ë¦¬ í™•ì¸: " + tempOutputFile.getParentFile().exists());
            }
            
            // ê°™ì€ ë””ë ‰í† ë¦¬ì˜ ë‹¤ë¥¸ íŒŒì¼ë“¤ í™•ì¸
            if (tempOutputFile.getParentFile() != null) {
                File[] files = tempOutputFile.getParentFile().listFiles();
                if (files != null) {
                    LoggerManager.logger("   â†’ ê°™ì€ ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ë“¤:");
                    for (File f : files) {
                        LoggerManager.logger("     - " + f.getName() + " (" + f.length() + " bytes)");
                    }
                } else {
                    LoggerManager.logger("   â†’ ë””ë ‰í† ë¦¬ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");
                }
            }
        }
    }
    
    /**
     * ê²€ì¦ ì‹¤íŒ¨ ìƒì„¸ ì •ë³´ ë¡œê¹… í—¬í¼ ë©”ì„œë“œ
     */
    private void logValidationFailureDetails(String tempOutputPath, File tempOutputFile, boolean copyWasSuccess) {
        LoggerManager.logger("   â†’ íŒŒì¼ ê²€ì¦ ì‹¤íŒ¨ ìƒì„¸ ë¶„ì„:");
        LoggerManager.logger("     - íŒŒì¼ ê²½ë¡œ: " + tempOutputPath);
        LoggerManager.logger("     - íŒŒì¼ ì¡´ì¬ ì—¬ë¶€: " + tempOutputFile.exists());
        LoggerManager.logger("     - íŒŒì¼ í¬ê¸°: " + (tempOutputFile.exists() ? tempOutputFile.length() + " bytes" : "N/A"));
        LoggerManager.logger("     - MediaMuxer ìƒíƒœ: " + muxerState);
        LoggerManager.logger("     - ë°ì´í„° ë³µì‚¬ ìƒíƒœ: " + (copyWasSuccess ? "ì„±ê³µ" : "ë¶€ë¶„ ì‹¤íŒ¨"));
        
        if (copyWasSuccess) {
            LoggerManager.logger("     - ê°€ëŠ¥í•œ ì›ì¸:");
            LoggerManager.logger("       * MediaMuxer.stop() ë¯¸í˜¸ì¶œ ë˜ëŠ” ì‹¤íŒ¨");
            LoggerManager.logger("       * ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡±");
            LoggerManager.logger("       * íŒŒì¼ ì‹œìŠ¤í…œ ì˜¤ë¥˜");
            LoggerManager.logger("       * í•œê¸€ íŒŒì¼ëª… ì¸ì½”ë”© ë¬¸ì œ");
            LoggerManager.logger("       * ê¶Œí•œ ë¬¸ì œ");
        }
    }
    
    /**
     * STEP 8: í¸ì§‘ ì „ìš© í´ë”ë¡œ íŒŒì¼ ì´ë™ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—°ë™)
     */
    private String moveToFinalDestination(File tempOutputFile, String fileName) {
        LoggerManager.logger("ğŸš€ STEP 8: í¸ì§‘ ì „ìš© í´ë”ë¡œ íŒŒì¼ ì´ë™ ì‹œì‘...");
        String tempOutputPath = tempOutputFile.getAbsolutePath();
        LoggerManager.logger("   â†’ ì›ë³¸ ìœ„ì¹˜: " + tempOutputPath);
        LoggerManager.logger("   â†’ ëŒ€ìƒ ìœ„ì¹˜: /Audios/Edited/");
        LoggerManager.logger("   â†’ ìµœì¢… íŒŒì¼ëª…: " + fileName);
        
        String finalOutputPath = moveToEditedDirectory(tempOutputFile, fileName);
        if (finalOutputPath == null) {
            LoggerManager.logger("âš ï¸ STEP 8 ì‹¤íŒ¨: í¸ì§‘ í´ë” ì´ë™ ì‹¤íŒ¨");
            LoggerManager.logger("   â†’ ì„ì‹œ íŒŒì¼ ìœ„ì¹˜ì—ì„œ ì™„ë£Œ ì²˜ë¦¬ ì‹œë„...");
            // ëŒ€ì•ˆ: ì„ì‹œ íŒŒì¼ ìœ„ì¹˜ì—ì„œ ì™„ë£Œ
            finalOutputPath = tempOutputPath;
        } else {
            LoggerManager.logger("âœ… STEP 8 ì™„ë£Œ: í¸ì§‘ í´ë” ì´ë™ ì„±ê³µ!");
            LoggerManager.logger("   â†’ ìµœì¢… ìœ„ì¹˜: " + finalOutputPath);
        }
        
        return finalOutputPath;
    }
}